<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds           #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase          #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings   #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications    #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-orphans #-}</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language.Rzk.VSCode.Handlers</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-9"></span><span>  </span><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#typecheckFromConfigFile"><span class="hs-identifier">typecheckFromConfigFile</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>  </span><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#provideCompletions"><span class="hs-identifier">provideCompletions</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>  </span><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#formatDocument"><span class="hs-identifier">formatDocument</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>  </span><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#provideSemanticTokens"><span class="hs-identifier">provideSemanticTokens</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>  </span><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#handleFilesChanged"><span class="hs-identifier">handleFilesChanged</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span>             </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">SomeException</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">evaluate</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">try</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>                 </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">forM_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">when</span></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ExceptT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ExceptT</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>                                                </span><span class="annot"><span class="hs-identifier">MonadError</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">throwError</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>                                                </span><span class="annot"><span class="hs-identifier">modifyError</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">runExceptT</span></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.IO.Class</span></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadIO</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Default.Class</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">isSuffixOf</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">sort</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(\\)</span></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fromMaybe</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">isNothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span>                     </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Yaml</span></span><span>                     </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Yaml</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Language.LSP.Diagnostics</span></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">partitionBySource</span></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Language.LSP.Protocol.Lens</span></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">HasDetail</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">detail</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>                                                </span><span class="annot"><span class="hs-identifier">HasDocumentation</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">documentation</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>                                                </span><span class="annot"><span class="hs-identifier">HasLabel</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-keyword">label</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>                                                </span><span class="annot"><span class="hs-identifier">HasParams</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">params</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>                                                </span><span class="annot"><span class="hs-identifier">HasTextDocument</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">textDocument</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>                                                </span><span class="annot"><span class="hs-identifier">HasUri</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">uri</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">changes</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">uri</span></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Language.LSP.Protocol.Message</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Language.LSP.Protocol.Types</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Language.LSP.Server</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Language.LSP.VFS</span></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">virtualFileText</span></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.FilePath</span></span><span>               </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">makeRelative</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(&lt;/&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.FilePath.Glob</span></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">compile</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">globDir</span></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Language.Rzk.Free.Syntax.html"><span class="hs-identifier">Language.Rzk.Free.Syntax</span></a></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Language.Rzk.Free.Syntax.html#RzkPosition"><span class="hs-identifier">RzkPosition</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Rzk.Free.Syntax.html#RzkPosition"><span class="hs-identifier">RzkPosition</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>                                                </span><span class="annot"><a href="Language.Rzk.Free.Syntax.html#VarIdent"><span class="hs-identifier">VarIdent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Rzk.Free.Syntax.html#getVarIdent"><span class="hs-identifier">getVarIdent</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Language.Rzk.Syntax.html"><span class="hs-identifier">Language.Rzk.Syntax</span></a></span><span>           </span><span class="hs-special">(</span><span class="annot"><a href="Language.Rzk.Syntax.Abs.html#Module"><span class="hs-identifier">Module</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Rzk.Syntax.Abs.html#VarIdent%27"><span class="hs-identifier">VarIdent'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Rzk.Syntax.Abs.html#VarIdent"><span class="hs-identifier">VarIdent</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>                                                </span><span class="annot"><a href="Language.Rzk.Syntax.html#parseModuleFile"><span class="hs-identifier">parseModuleFile</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>                                                </span><span class="annot"><a href="Language.Rzk.Syntax.html#parseModuleSafe"><span class="hs-identifier">parseModuleSafe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Rzk.Syntax.html#printTree"><span class="hs-identifier">printTree</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Language.Rzk.VSCode.Config.html"><span class="hs-identifier">Language.Rzk.VSCode.Config</span></a></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Language.Rzk.VSCode.Config.html#ServerConfig"><span class="hs-identifier">ServerConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Rzk.VSCode.Config.html#ServerConfig"><span class="hs-identifier">ServerConfig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Rzk.VSCode.Config.html#formatEnabled"><span class="hs-identifier">formatEnabled</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Language.Rzk.VSCode.Env.html"><span class="hs-identifier">Language.Rzk.VSCode.Env</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Language.Rzk.VSCode.Logging.html"><span class="hs-identifier">Language.Rzk.VSCode.Logging</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Language.Rzk.VSCode.Tokenize.html"><span class="hs-identifier">Language.Rzk.VSCode.Tokenize</span></a></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Language.Rzk.VSCode.Tokenize.html#tokenizeModule"><span class="hs-identifier">tokenizeModule</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Rzk.Format.html"><span class="hs-identifier">Rzk.Format</span></a></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="Rzk.Format.html#FormattingEdit"><span class="hs-identifier">FormattingEdit</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-52"></span><span>                                                </span><span class="annot"><a href="Rzk.Format.html#formatTextEdits"><span class="hs-identifier">formatTextEdits</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Rzk.Project.Config.html"><span class="hs-identifier">Rzk.Project.Config</span></a></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="Rzk.Project.Config.html#ProjectConfig"><span class="hs-identifier">ProjectConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rzk.Project.Config.html#include"><span class="hs-identifier">include</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Rzk.TypeCheck.html"><span class="hs-identifier">Rzk.TypeCheck</span></a></span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="hs-comment">-- | Given a list of file paths, reads them and parses them as Rzk modules,</span><span>
</span><span id="line-57"></span><span class="hs-comment">--   returning the same list of file paths but with the parsed module (or parse error)</span><span>
</span><span id="line-58"></span><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#parseFiles"><span class="hs-identifier hs-type">parseFiles</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><a href="Language.Rzk.Syntax.Abs.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-59"></span><span id="parseFiles"><span class="annot"><span class="annottext">parseFiles :: [FilePath] -&gt; IO [(FilePath, Either FilePath Module)]
</span><a href="Language.Rzk.VSCode.Handlers.html#parseFiles"><span class="hs-identifier hs-var hs-var">parseFiles</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(FilePath, Either FilePath Module)]
-&gt; IO [(FilePath, Either FilePath Module)]
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-60"></span><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#parseFiles"><span class="hs-identifier hs-var">parseFiles</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679734818"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734818"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679734819"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679734819"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-61"></span><span>  </span><span id="local-6989586621679734820"><span class="annot"><span class="annottext">Either FilePath Module
</span><a href="#local-6989586621679734820"><span class="hs-identifier hs-var">errOrMod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO (Either FilePath Module)
</span><a href="Language.Rzk.Syntax.html#parseModuleFile"><span class="hs-identifier hs-var">parseModuleFile</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734818"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-62"></span><span>  </span><span id="local-6989586621679734821"><span class="annot"><span class="annottext">[(FilePath, Either FilePath Module)]
</span><a href="#local-6989586621679734821"><span class="hs-identifier hs-var">rest</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[FilePath] -&gt; IO [(FilePath, Either FilePath Module)]
</span><a href="Language.Rzk.VSCode.Handlers.html#parseFiles"><span class="hs-identifier hs-var">parseFiles</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679734819"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-63"></span><span>  </span><span class="annot"><span class="annottext">[(FilePath, Either FilePath Module)]
-&gt; IO [(FilePath, Either FilePath Module)]
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([(FilePath, Either FilePath Module)]
 -&gt; IO [(FilePath, Either FilePath Module)])
-&gt; [(FilePath, Either FilePath Module)]
-&gt; IO [(FilePath, Either FilePath Module)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734818"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Either FilePath Module
</span><a href="#local-6989586621679734820"><span class="hs-identifier hs-var">errOrMod</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(FilePath, Either FilePath Module)
-&gt; [(FilePath, Either FilePath Module)]
-&gt; [(FilePath, Either FilePath Module)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(FilePath, Either FilePath Module)]
</span><a href="#local-6989586621679734821"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-comment">-- | Given the list of possible modules returned by `parseFiles`, this segregates the errors</span><span>
</span><span id="line-66"></span><span class="hs-comment">--   from the successfully parsed modules and returns them in separate lists so the errors</span><span>
</span><span id="line-67"></span><span class="hs-comment">--   can be reported and the modules can be typechecked.</span><span>
</span><span id="line-68"></span><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#collectErrors"><span class="hs-identifier hs-type">collectErrors</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><a href="Language.Rzk.Syntax.Abs.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Rzk.Syntax.Abs.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span id="collectErrors"><span class="annot"><span class="annottext">collectErrors :: [(FilePath, Either FilePath Module)]
-&gt; ([(FilePath, FilePath)], [(FilePath, Module)])
</span><a href="Language.Rzk.VSCode.Handlers.html#collectErrors"><span class="hs-identifier hs-var hs-var">collectErrors</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#collectErrors"><span class="hs-identifier hs-var">collectErrors</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679734823"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734823"><span class="hs-identifier hs-var">path</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679734824"><span class="annot"><span class="annottext">Either FilePath Module
</span><a href="#local-6989586621679734824"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679734825"><span class="annot"><span class="annottext">[(FilePath, Either FilePath Module)]
</span><a href="#local-6989586621679734825"><span class="hs-identifier hs-var">paths</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-71"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either FilePath Module
</span><a href="#local-6989586621679734824"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-72"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679734826"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734826"><span class="hs-identifier hs-var">err</span></a></span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734823"><span class="hs-identifier hs-var">path</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734826"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(FilePath, FilePath)
-&gt; [(FilePath, FilePath)] -&gt; [(FilePath, FilePath)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(FilePath, FilePath)]
</span><a href="#local-6989586621679734827"><span class="hs-identifier hs-var">errors</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679734828"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621679734828"><span class="hs-identifier hs-var">module_</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(FilePath, FilePath)]
</span><a href="#local-6989586621679734827"><span class="hs-identifier hs-var">errors</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734823"><span class="hs-identifier hs-var">path</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621679734828"><span class="hs-identifier hs-var">module_</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(FilePath, Module) -&gt; [(FilePath, Module)] -&gt; [(FilePath, Module)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(FilePath, Module)]
</span><a href="#local-6989586621679734829"><span class="hs-identifier hs-var">modules</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-75"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679734827"><span class="annot"><span class="annottext">[(FilePath, FilePath)]
</span><a href="#local-6989586621679734827"><span class="hs-identifier hs-var">errors</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679734829"><span class="annot"><span class="annottext">[(FilePath, Module)]
</span><a href="#local-6989586621679734829"><span class="hs-identifier hs-var">modules</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(FilePath, Either FilePath Module)]
-&gt; ([(FilePath, FilePath)], [(FilePath, Module)])
</span><a href="Language.Rzk.VSCode.Handlers.html#collectErrors"><span class="hs-identifier hs-var">collectErrors</span></a></span><span> </span><span class="annot"><span class="annottext">[(FilePath, Either FilePath Module)]
</span><a href="#local-6989586621679734825"><span class="hs-identifier hs-var">paths</span></a></span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="annot"><span class="hs-comment">-- | The maximum number of diagnostic messages to send to the client</span></span><span>
</span><span id="line-78"></span><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#maxDiagnosticCount"><span class="hs-identifier hs-type">maxDiagnosticCount</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-79"></span><span id="maxDiagnosticCount"><span class="annot"><span class="annottext">maxDiagnosticCount :: Int
</span><a href="Language.Rzk.VSCode.Handlers.html#maxDiagnosticCount"><span class="hs-identifier hs-var hs-var">maxDiagnosticCount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">100</span></span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#filePathToNormalizedUri"><span class="hs-identifier hs-type">filePathToNormalizedUri</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NormalizedUri</span></span><span>
</span><span id="line-82"></span><span id="filePathToNormalizedUri"><span class="annot"><span class="annottext">filePathToNormalizedUri :: FilePath -&gt; NormalizedUri
</span><a href="Language.Rzk.VSCode.Handlers.html#filePathToNormalizedUri"><span class="hs-identifier hs-var hs-var">filePathToNormalizedUri</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Uri -&gt; NormalizedUri
</span><span class="hs-identifier hs-var">toNormalizedUri</span></span><span> </span><span class="annot"><span class="annottext">(Uri -&gt; NormalizedUri)
-&gt; (FilePath -&gt; Uri) -&gt; FilePath -&gt; NormalizedUri
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Uri
</span><span class="hs-identifier hs-var">filePathToUri</span></span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#typecheckFromConfigFile"><span class="hs-identifier hs-type">typecheckFromConfigFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Rzk.VSCode.Env.html#LSP"><span class="hs-identifier hs-type">LSP</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span id="typecheckFromConfigFile"><span class="annot"><span class="annottext">typecheckFromConfigFile :: LSP ()
</span><a href="Language.Rzk.VSCode.Handlers.html#typecheckFromConfigFile"><span class="hs-identifier hs-var hs-var">typecheckFromConfigFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-87"></span><span>  </span><span class="annot"><span class="annottext">FilePath -&gt; LSP ()
forall c (m :: * -&gt; *). MonadLsp c m =&gt; FilePath -&gt; m ()
</span><a href="Language.Rzk.VSCode.Logging.html#logInfo"><span class="hs-identifier hs-var">logInfo</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Looking for rzk.yaml&quot;</span></span><span>
</span><span id="line-88"></span><span>  </span><span id="local-6989586621679734836"><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="#local-6989586621679734836"><span class="hs-identifier hs-var">root</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LspT ServerConfig (ReaderT RzkEnv IO) (Maybe FilePath)
forall config (m :: * -&gt; *).
MonadLsp config m =&gt;
m (Maybe FilePath)
</span><span class="hs-identifier hs-var">getRootPath</span></span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="#local-6989586621679734836"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-90"></span><span>    </span><span class="annot"><span class="annottext">Maybe FilePath
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-91"></span><span>      </span><span class="annot"><span class="annottext">FilePath -&gt; LSP ()
forall c (m :: * -&gt; *). MonadLsp c m =&gt; FilePath -&gt; m ()
</span><a href="Language.Rzk.VSCode.Logging.html#logWarning"><span class="hs-identifier hs-var">logWarning</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Workspace has no root path, cannot find rzk.yaml&quot;</span></span><span>
</span><span id="line-92"></span><span>      </span><span class="annot"><span class="annottext">SServerMethod 'Method_WindowShowMessage
-&gt; MessageParams 'Method_WindowShowMessage -&gt; LSP ()
forall (m :: Method 'ServerToClient 'Notification) (f :: * -&gt; *)
       config.
MonadLsp config f =&gt;
SServerMethod m -&gt; MessageParams m -&gt; f ()
</span><span class="hs-identifier hs-var">sendNotification</span></span><span> </span><span class="annot"><span class="annottext">SServerMethod 'Method_WindowShowMessage
</span><span class="hs-identifier hs-var">SMethod_WindowShowMessage</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MessageType -&gt; Text -&gt; ShowMessageParams
</span><span class="hs-identifier hs-var">ShowMessageParams</span></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><span class="hs-identifier hs-var">MessageType_Warning</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Cannot find the workspace root&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679734843"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734843"><span class="hs-identifier hs-var">rootPath</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-94"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679734844"><span class="annot"><span class="annottext">rzkYamlPath :: FilePath
</span><a href="#local-6989586621679734844"><span class="hs-identifier hs-var hs-var">rzkYamlPath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734843"><span class="hs-identifier hs-var">rootPath</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;rzk.yaml&quot;</span></span><span>
</span><span id="line-95"></span><span>      </span><span id="local-6989586621679734845"><span class="annot"><span class="annottext">Either ParseException ProjectConfig
</span><a href="#local-6989586621679734845"><span class="hs-identifier hs-var">eitherConfig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Either ParseException ProjectConfig)
-&gt; LspT
     ServerConfig
     (ReaderT RzkEnv IO)
     (Either ParseException ProjectConfig)
forall a. IO a -&gt; LspT ServerConfig (ReaderT RzkEnv IO) a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either ParseException ProjectConfig)
 -&gt; LspT
      ServerConfig
      (ReaderT RzkEnv IO)
      (Either ParseException ProjectConfig))
-&gt; IO (Either ParseException ProjectConfig)
-&gt; LspT
     ServerConfig
     (ReaderT RzkEnv IO)
     (Either ParseException ProjectConfig)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. FromJSON a =&gt; FilePath -&gt; IO (Either ParseException a)
</span><span class="hs-identifier hs-var">Yaml.decodeFileEither</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Rzk.Project.Config.html#ProjectConfig"><span class="hs-identifier hs-type">ProjectConfig</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734844"><span class="hs-identifier hs-var">rzkYamlPath</span></a></span><span>
</span><span id="line-96"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either ParseException ProjectConfig
</span><a href="#local-6989586621679734845"><span class="hs-identifier hs-var">eitherConfig</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-97"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679734848"><span class="annot"><span class="annottext">ParseException
</span><a href="#local-6989586621679734848"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-98"></span><span>          </span><span class="annot"><span class="annottext">FilePath -&gt; LSP ()
forall c (m :: * -&gt; *). MonadLsp c m =&gt; FilePath -&gt; m ()
</span><a href="Language.Rzk.VSCode.Logging.html#logError"><span class="hs-identifier hs-var">logError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Invalid or missing rzk.yaml: &quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">ParseException -&gt; FilePath
</span><span class="hs-identifier hs-var">Yaml.prettyPrintParseException</span></span><span> </span><span class="annot"><span class="annottext">ParseException
</span><a href="#local-6989586621679734848"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679734851"><span class="annot"><span class="annottext">ProjectConfig
</span><a href="#local-6989586621679734851"><span class="hs-identifier hs-var">config</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-101"></span><span>          </span><span class="annot"><span class="annottext">FilePath -&gt; LSP ()
forall c (m :: * -&gt; *). MonadLsp c m =&gt; FilePath -&gt; m ()
</span><a href="Language.Rzk.VSCode.Logging.html#logDebug"><span class="hs-identifier hs-var">logDebug</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Starting typechecking&quot;</span></span><span>
</span><span id="line-102"></span><span>          </span><span id="local-6989586621679734853"><span class="annot"><span class="annottext">[[FilePath]]
</span><a href="#local-6989586621679734853"><span class="hs-identifier hs-var">rawPaths</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [[FilePath]]
-&gt; LspT ServerConfig (ReaderT RzkEnv IO) [[FilePath]]
forall a. IO a -&gt; LspT ServerConfig (ReaderT RzkEnv IO) a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO [[FilePath]]
 -&gt; LspT ServerConfig (ReaderT RzkEnv IO) [[FilePath]])
-&gt; IO [[FilePath]]
-&gt; LspT ServerConfig (ReaderT RzkEnv IO) [[FilePath]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Pattern] -&gt; FilePath -&gt; IO [[FilePath]]
</span><span class="hs-identifier hs-var">globDir</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(FilePath -&gt; Pattern) -&gt; [FilePath] -&gt; [Pattern]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Pattern
</span><span class="hs-identifier hs-var">compile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ProjectConfig -&gt; [FilePath]
</span><a href="Rzk.Project.Config.html#include"><span class="hs-identifier hs-var">include</span></a></span><span> </span><span class="annot"><span class="annottext">ProjectConfig
</span><a href="#local-6989586621679734851"><span class="hs-identifier hs-var">config</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734843"><span class="hs-identifier hs-var">rootPath</span></a></span><span>
</span><span id="line-103"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679734859"><span class="annot"><span class="annottext">paths :: [FilePath]
</span><a href="#local-6989586621679734859"><span class="hs-identifier hs-var hs-var">paths</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([FilePath] -&gt; [FilePath]) -&gt; [[FilePath]] -&gt; [FilePath]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">[FilePath] -&gt; [FilePath]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sort</span></span><span> </span><span class="annot"><span class="annottext">[[FilePath]]
</span><a href="#local-6989586621679734853"><span class="hs-identifier hs-var">rawPaths</span></a></span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span>          </span><span id="local-6989586621679734861"><span class="annot"><span class="annottext">RzkTypecheckCache
</span><a href="#local-6989586621679734861"><span class="hs-identifier hs-var">cachedModules</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LSP RzkTypecheckCache
</span><a href="Language.Rzk.VSCode.Env.html#getCachedTypecheckedModules"><span class="hs-identifier hs-var">getCachedTypecheckedModules</span></a></span><span>
</span><span id="line-106"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679734863"><span class="annot"><span class="annottext">cachedPaths :: [FilePath]
</span><a href="#local-6989586621679734863"><span class="hs-identifier hs-var hs-var">cachedPaths</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((FilePath, [Decl']) -&gt; FilePath)
-&gt; RzkTypecheckCache -&gt; [FilePath]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(FilePath, [Decl']) -&gt; FilePath
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">RzkTypecheckCache
</span><a href="#local-6989586621679734861"><span class="hs-identifier hs-var">cachedModules</span></a></span><span>
</span><span id="line-107"></span><span>              </span><span id="local-6989586621679734867"><span class="annot"><span class="annottext">modifiedFiles :: [FilePath]
</span><a href="#local-6989586621679734867"><span class="hs-identifier hs-var hs-var">modifiedFiles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679734859"><span class="hs-identifier hs-var">paths</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath] -&gt; [FilePath] -&gt; [FilePath]
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">\\</span></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679734863"><span class="hs-identifier hs-var">cachedPaths</span></a></span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span>          </span><span class="annot"><span class="annottext">FilePath -&gt; LSP ()
forall c (m :: * -&gt; *). MonadLsp c m =&gt; FilePath -&gt; m ()
</span><a href="Language.Rzk.VSCode.Logging.html#logDebug"><span class="hs-identifier hs-var">logDebug</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Found &quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[FilePath] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679734863"><span class="hs-identifier hs-var">cachedPaths</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot; files in the cache&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span>          </span><span class="annot"><span class="annottext">FilePath -&gt; LSP ()
forall c (m :: * -&gt; *). MonadLsp c m =&gt; FilePath -&gt; m ()
</span><a href="Language.Rzk.VSCode.Logging.html#logDebug"><span class="hs-identifier hs-var">logDebug</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[FilePath] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679734867"><span class="hs-identifier hs-var">modifiedFiles</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot; files have been modified&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679734870"><span class="annot"><span class="annottext">[(FilePath, FilePath)]
</span><a href="#local-6989586621679734870"><span class="hs-identifier hs-var">parseErrors</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679734871"><span class="annot"><span class="annottext">[(FilePath, Module)]
</span><a href="#local-6989586621679734871"><span class="hs-identifier hs-var">parsedModules</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ([(FilePath, FilePath)], [(FilePath, Module)])
-&gt; LspT
     ServerConfig
     (ReaderT RzkEnv IO)
     ([(FilePath, FilePath)], [(FilePath, Module)])
forall a. IO a -&gt; LspT ServerConfig (ReaderT RzkEnv IO) a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO ([(FilePath, FilePath)], [(FilePath, Module)])
 -&gt; LspT
      ServerConfig
      (ReaderT RzkEnv IO)
      ([(FilePath, FilePath)], [(FilePath, Module)]))
-&gt; IO ([(FilePath, FilePath)], [(FilePath, Module)])
-&gt; LspT
     ServerConfig
     (ReaderT RzkEnv IO)
     ([(FilePath, FilePath)], [(FilePath, Module)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(FilePath, Either FilePath Module)]
-&gt; ([(FilePath, FilePath)], [(FilePath, Module)])
</span><a href="Language.Rzk.VSCode.Handlers.html#collectErrors"><span class="hs-identifier hs-var">collectErrors</span></a></span><span> </span><span class="annot"><span class="annottext">([(FilePath, Either FilePath Module)]
 -&gt; ([(FilePath, FilePath)], [(FilePath, Module)]))
-&gt; IO [(FilePath, Either FilePath Module)]
-&gt; IO ([(FilePath, FilePath)], [(FilePath, Module)])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[FilePath] -&gt; IO [(FilePath, Either FilePath Module)]
</span><a href="Language.Rzk.VSCode.Handlers.html#parseFiles"><span class="hs-identifier hs-var">parseFiles</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679734867"><span class="hs-identifier hs-var">modifiedFiles</span></a></span><span>
</span><span id="line-113"></span><span>          </span><span id="local-6989586621679734873"><span class="annot"><span class="annottext">Either
  SomeException
  (Either
     (TypeErrorInScopedContext VarIdent)
     (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent]))
</span><a href="#local-6989586621679734873"><span class="hs-identifier hs-var">tcResults</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO
  (Either
     SomeException
     (Either
        (TypeErrorInScopedContext VarIdent)
        (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])))
-&gt; LspT
     ServerConfig
     (ReaderT RzkEnv IO)
     (Either
        SomeException
        (Either
           (TypeErrorInScopedContext VarIdent)
           (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])))
forall a. IO a -&gt; LspT ServerConfig (ReaderT RzkEnv IO) a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO
   (Either
      SomeException
      (Either
         (TypeErrorInScopedContext VarIdent)
         (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])))
 -&gt; LspT
      ServerConfig
      (ReaderT RzkEnv IO)
      (Either
         SomeException
         (Either
            (TypeErrorInScopedContext VarIdent)
            (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent]))))
-&gt; IO
     (Either
        SomeException
        (Either
           (TypeErrorInScopedContext VarIdent)
           (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])))
-&gt; LspT
     ServerConfig
     (ReaderT RzkEnv IO)
     (Either
        SomeException
        (Either
           (TypeErrorInScopedContext VarIdent)
           (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO
  (Either
     (TypeErrorInScopedContext VarIdent)
     (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent]))
-&gt; IO
     (Either
        SomeException
        (Either
           (TypeErrorInScopedContext VarIdent)
           (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])))
forall e a. Exception e =&gt; IO a -&gt; IO (Either e a)
</span><span class="hs-identifier hs-var">try</span></span><span> </span><span class="annot"><span class="annottext">(IO
   (Either
      (TypeErrorInScopedContext VarIdent)
      (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent]))
 -&gt; IO
      (Either
         SomeException
         (Either
            (TypeErrorInScopedContext VarIdent)
            (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent]))))
-&gt; IO
     (Either
        (TypeErrorInScopedContext VarIdent)
        (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent]))
-&gt; IO
     (Either
        SomeException
        (Either
           (TypeErrorInScopedContext VarIdent)
           (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Either
  (TypeErrorInScopedContext VarIdent)
  (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])
-&gt; IO
     (Either
        (TypeErrorInScopedContext VarIdent)
        (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent]))
forall a. a -&gt; IO a
</span><span class="hs-identifier hs-var">evaluate</span></span><span> </span><span class="annot"><span class="annottext">(Either
   (TypeErrorInScopedContext VarIdent)
   (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])
 -&gt; IO
      (Either
         (TypeErrorInScopedContext VarIdent)
         (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])))
-&gt; Either
     (TypeErrorInScopedContext VarIdent)
     (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])
-&gt; IO
     (Either
        (TypeErrorInScopedContext VarIdent)
        (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-114"></span><span>            </span><span class="annot"><span class="annottext">TypeCheck
  VarIdent (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])
-&gt; Either
     (TypeErrorInScopedContext VarIdent)
     (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])
forall var a.
TypeCheck var a -&gt; Either (TypeErrorInScopedContext var) a
</span><a href="Rzk.TypeCheck.html#defaultTypeCheck"><span class="hs-identifier hs-var">defaultTypeCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RzkTypecheckCache
-&gt; [(FilePath, Module)]
-&gt; TypeCheck
     VarIdent (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])
</span><a href="Rzk.TypeCheck.html#typecheckModulesWithLocationIncremental"><span class="hs-identifier hs-var">typecheckModulesWithLocationIncremental</span></a></span><span> </span><span class="annot"><span class="annottext">RzkTypecheckCache
</span><a href="#local-6989586621679734861"><span class="hs-identifier hs-var">cachedModules</span></a></span><span> </span><span class="annot"><span class="annottext">[(FilePath, Module)]
</span><a href="#local-6989586621679734871"><span class="hs-identifier hs-var">parsedModules</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679734876"><span class="annot"><span class="annottext">[TypeErrorInScopedContext VarIdent]
</span><a href="#local-6989586621679734876"><span class="hs-identifier hs-var">typeErrors</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679734877"><span class="annot"><span class="annottext">RzkTypecheckCache
</span><a href="#local-6989586621679734877"><span class="hs-identifier hs-var">_checkedModules</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either
  SomeException
  (Either
     (TypeErrorInScopedContext VarIdent)
     (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent]))
</span><a href="#local-6989586621679734873"><span class="hs-identifier hs-var">tcResults</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-117"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679734878"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679734878"><span class="hs-identifier hs-var">ex</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-118"></span><span>              </span><span class="hs-comment">-- Just a warning to be logged in the &quot;Output&quot; panel and not shown to the user as an error message</span><span>
</span><span id="line-119"></span><span>              </span><span class="hs-comment">--  because exceptions are expected when the file has invalid syntax</span><span>
</span><span id="line-120"></span><span>              </span><span class="annot"><span class="annottext">FilePath -&gt; LSP ()
forall c (m :: * -&gt; *). MonadLsp c m =&gt; FilePath -&gt; m ()
</span><a href="Language.Rzk.VSCode.Logging.html#logWarning"><span class="hs-identifier hs-var">logWarning</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Encountered an exception while typechecking:\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679734878"><span class="hs-identifier hs-var">ex</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span>              </span><span class="annot"><span class="annottext">([TypeErrorInScopedContext VarIdent], RzkTypecheckCache)
-&gt; LspT
     ServerConfig
     (ReaderT RzkEnv IO)
     ([TypeErrorInScopedContext VarIdent], RzkTypecheckCache)
forall a. a -&gt; LspT ServerConfig (ReaderT RzkEnv IO) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679734879"><span class="annot"><span class="annottext">TypeErrorInScopedContext VarIdent
</span><a href="#local-6989586621679734879"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-123"></span><span>              </span><span class="annot"><span class="annottext">FilePath -&gt; LSP ()
forall c (m :: * -&gt; *). MonadLsp c m =&gt; FilePath -&gt; m ()
</span><a href="Language.Rzk.VSCode.Logging.html#logError"><span class="hs-identifier hs-var">logError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;An impossible error happened! Please report a bug:\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">OutputDirection -&gt; TypeErrorInScopedContext VarIdent -&gt; FilePath
</span><a href="Rzk.TypeCheck.html#ppTypeErrorInScopedContext%27"><span class="hs-identifier hs-var">ppTypeErrorInScopedContext'</span></a></span><span> </span><span class="annot"><span class="annottext">OutputDirection
</span><a href="Rzk.TypeCheck.html#BottomUp"><span class="hs-identifier hs-var">BottomUp</span></a></span><span> </span><span class="annot"><span class="annottext">TypeErrorInScopedContext VarIdent
</span><a href="#local-6989586621679734879"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>              </span><span class="annot"><span class="annottext">([TypeErrorInScopedContext VarIdent], RzkTypecheckCache)
-&gt; LspT
     ServerConfig
     (ReaderT RzkEnv IO)
     ([TypeErrorInScopedContext VarIdent], RzkTypecheckCache)
forall a. a -&gt; LspT ServerConfig (ReaderT RzkEnv IO) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">TypeErrorInScopedContext VarIdent
</span><a href="#local-6989586621679734879"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- sort of impossible</span><span>
</span><span id="line-125"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679734882"><span class="annot"><span class="annottext">RzkTypecheckCache
</span><a href="#local-6989586621679734882"><span class="hs-identifier hs-var">checkedModules</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679734883"><span class="annot"><span class="annottext">[TypeErrorInScopedContext VarIdent]
</span><a href="#local-6989586621679734883"><span class="hs-identifier hs-var">errors</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-126"></span><span>                </span><span class="hs-comment">-- cache well-typed modules</span><span>
</span><span id="line-127"></span><span>                </span><span class="annot"><span class="annottext">FilePath -&gt; LSP ()
forall c (m :: * -&gt; *). MonadLsp c m =&gt; FilePath -&gt; m ()
</span><a href="Language.Rzk.VSCode.Logging.html#logInfo"><span class="hs-identifier hs-var">logInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RzkTypecheckCache -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">RzkTypecheckCache
</span><a href="#local-6989586621679734882"><span class="hs-identifier hs-var">checkedModules</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot; modules successfully typechecked&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>                </span><span class="annot"><span class="annottext">FilePath -&gt; LSP ()
forall c (m :: * -&gt; *). MonadLsp c m =&gt; FilePath -&gt; m ()
</span><a href="Language.Rzk.VSCode.Logging.html#logInfo"><span class="hs-identifier hs-var">logInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TypeErrorInScopedContext VarIdent] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[TypeErrorInScopedContext VarIdent]
</span><a href="#local-6989586621679734883"><span class="hs-identifier hs-var">errors</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot; errors found&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>                </span><span class="annot"><span class="annottext">RzkTypecheckCache -&gt; LSP ()
</span><a href="Language.Rzk.VSCode.Env.html#cacheTypecheckedModules"><span class="hs-identifier hs-var">cacheTypecheckedModules</span></a></span><span> </span><span class="annot"><span class="annottext">RzkTypecheckCache
</span><a href="#local-6989586621679734882"><span class="hs-identifier hs-var">checkedModules</span></a></span><span>
</span><span id="line-130"></span><span>                </span><span class="annot"><span class="annottext">([TypeErrorInScopedContext VarIdent], RzkTypecheckCache)
-&gt; LspT
     ServerConfig
     (ReaderT RzkEnv IO)
     ([TypeErrorInScopedContext VarIdent], RzkTypecheckCache)
forall a. a -&gt; LspT ServerConfig (ReaderT RzkEnv IO) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TypeErrorInScopedContext VarIdent]
</span><a href="#local-6989586621679734883"><span class="hs-identifier hs-var">errors</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RzkTypecheckCache
</span><a href="#local-6989586621679734882"><span class="hs-identifier hs-var">checkedModules</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-131"></span><span>
</span><span id="line-132"></span><span>          </span><span class="hs-comment">-- Reset all published diags</span><span>
</span><span id="line-133"></span><span>          </span><span class="hs-comment">-- TODO: remove this after properly grouping by path below, after which there can be an empty list of errors</span><span>
</span><span id="line-134"></span><span>          </span><span class="hs-comment">-- TODO: handle clearing diagnostics for files that got removed from the project (rzk.yaml)</span><span>
</span><span id="line-135"></span><span>          </span><span class="annot"><span class="annottext">[FilePath] -&gt; (FilePath -&gt; LSP ()) -&gt; LSP ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679734859"><span class="hs-identifier hs-var">paths</span></a></span><span> </span><span class="annot"><span class="annottext">((FilePath -&gt; LSP ()) -&gt; LSP ()) -&gt; (FilePath -&gt; LSP ()) -&gt; LSP ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679734885"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734885"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-136"></span><span>            </span><span class="annot"><span class="annottext">Int
-&gt; NormalizedUri -&gt; Maybe Int32 -&gt; DiagnosticsBySource -&gt; LSP ()
forall config (m :: * -&gt; *).
MonadLsp config m =&gt;
Int -&gt; NormalizedUri -&gt; Maybe Int32 -&gt; DiagnosticsBySource -&gt; m ()
</span><span class="hs-identifier hs-var">publishDiagnostics</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; NormalizedUri
</span><a href="Language.Rzk.VSCode.Handlers.html#filePathToNormalizedUri"><span class="hs-identifier hs-var">filePathToNormalizedUri</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734885"><span class="hs-identifier hs-var">path</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Int32
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Diagnostic] -&gt; DiagnosticsBySource
</span><span class="hs-identifier hs-var">partitionBySource</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span>          </span><span class="hs-comment">-- Report parse errors to the client</span><span>
</span><span id="line-139"></span><span>          </span><span class="annot"><span class="annottext">[(FilePath, FilePath)]
-&gt; ((FilePath, FilePath) -&gt; LSP ()) -&gt; LSP ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[(FilePath, FilePath)]
</span><a href="#local-6989586621679734870"><span class="hs-identifier hs-var">parseErrors</span></a></span><span> </span><span class="annot"><span class="annottext">(((FilePath, FilePath) -&gt; LSP ()) -&gt; LSP ())
-&gt; ((FilePath, FilePath) -&gt; LSP ()) -&gt; LSP ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679734887"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734887"><span class="hs-identifier hs-var">path</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679734888"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734888"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-140"></span><span>            </span><span class="annot"><span class="annottext">Int
-&gt; NormalizedUri -&gt; Maybe Int32 -&gt; DiagnosticsBySource -&gt; LSP ()
forall config (m :: * -&gt; *).
MonadLsp config m =&gt;
Int -&gt; NormalizedUri -&gt; Maybe Int32 -&gt; DiagnosticsBySource -&gt; m ()
</span><span class="hs-identifier hs-var">publishDiagnostics</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Language.Rzk.VSCode.Handlers.html#maxDiagnosticCount"><span class="hs-identifier hs-var">maxDiagnosticCount</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; NormalizedUri
</span><a href="Language.Rzk.VSCode.Handlers.html#filePathToNormalizedUri"><span class="hs-identifier hs-var">filePathToNormalizedUri</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734887"><span class="hs-identifier hs-var">path</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Int32
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Diagnostic] -&gt; DiagnosticsBySource
</span><span class="hs-identifier hs-var">partitionBySource</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">FilePath -&gt; Diagnostic
</span><a href="#local-6989586621679734889"><span class="hs-identifier hs-var">diagnosticOfParseError</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734888"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span>          </span><span class="hs-comment">-- TODO: collect all errors for one file in one list</span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span>          </span><span class="hs-comment">-- Report typechecking errors to the client</span><span>
</span><span id="line-145"></span><span>          </span><span class="annot"><span class="annottext">[TypeErrorInScopedContext VarIdent]
-&gt; (TypeErrorInScopedContext VarIdent -&gt; LSP ()) -&gt; LSP ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[TypeErrorInScopedContext VarIdent]
</span><a href="#local-6989586621679734876"><span class="hs-identifier hs-var">typeErrors</span></a></span><span> </span><span class="annot"><span class="annottext">((TypeErrorInScopedContext VarIdent -&gt; LSP ()) -&gt; LSP ())
-&gt; (TypeErrorInScopedContext VarIdent -&gt; LSP ()) -&gt; LSP ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679734890"><span class="annot"><span class="annottext">TypeErrorInScopedContext VarIdent
</span><a href="#local-6989586621679734890"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-146"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679734891"><span class="annot"><span class="annottext">errPath :: FilePath
</span><a href="#local-6989586621679734891"><span class="hs-identifier hs-var hs-var">errPath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeErrorInScopedContext VarIdent -&gt; FilePath
forall var. TypeErrorInScopedContext var -&gt; FilePath
</span><a href="#local-6989586621679734892"><span class="hs-identifier hs-var">filepathOfTypeError</span></a></span><span> </span><span class="annot"><span class="annottext">TypeErrorInScopedContext VarIdent
</span><a href="#local-6989586621679734890"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-147"></span><span>                </span><span id="local-6989586621679734893"><span class="annot"><span class="annottext">errDiagnostic :: Diagnostic
</span><a href="#local-6989586621679734893"><span class="hs-identifier hs-var hs-var">errDiagnostic</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeErrorInScopedContext VarIdent -&gt; Diagnostic
</span><a href="#local-6989586621679734894"><span class="hs-identifier hs-var">diagnosticOfTypeError</span></a></span><span> </span><span class="annot"><span class="annottext">TypeErrorInScopedContext VarIdent
</span><a href="#local-6989586621679734890"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-148"></span><span>            </span><span class="annot"><span class="annottext">Int
-&gt; NormalizedUri -&gt; Maybe Int32 -&gt; DiagnosticsBySource -&gt; LSP ()
forall config (m :: * -&gt; *).
MonadLsp config m =&gt;
Int -&gt; NormalizedUri -&gt; Maybe Int32 -&gt; DiagnosticsBySource -&gt; m ()
</span><span class="hs-identifier hs-var">publishDiagnostics</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Language.Rzk.VSCode.Handlers.html#maxDiagnosticCount"><span class="hs-identifier hs-var">maxDiagnosticCount</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; NormalizedUri
</span><a href="Language.Rzk.VSCode.Handlers.html#filePathToNormalizedUri"><span class="hs-identifier hs-var">filePathToNormalizedUri</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734891"><span class="hs-identifier hs-var">errPath</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Int32
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Diagnostic] -&gt; DiagnosticsBySource
</span><span class="hs-identifier hs-var">partitionBySource</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Diagnostic
</span><a href="#local-6989586621679734893"><span class="hs-identifier hs-var">errDiagnostic</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-150"></span><span>    </span><span id="local-6989586621679734329"><span class="annot"><a href="#local-6989586621679734892"><span class="hs-identifier hs-type">filepathOfTypeError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Rzk.TypeCheck.html#TypeErrorInScopedContext"><span class="hs-identifier hs-type">TypeErrorInScopedContext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679734329"><span class="hs-identifier hs-type">var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span></span><span>
</span><span id="line-151"></span><span>    </span><span id="local-6989586621679734892"><span class="annot"><span class="annottext">filepathOfTypeError :: forall var. TypeErrorInScopedContext var -&gt; FilePath
</span><a href="#local-6989586621679734892"><span class="hs-identifier hs-var hs-var">filepathOfTypeError</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rzk.TypeCheck.html#PlainTypeError"><span class="hs-identifier hs-type">PlainTypeError</span></a></span><span> </span><span id="local-6989586621679734900"><span class="annot"><span class="annottext">TypeErrorInContext var
</span><a href="#local-6989586621679734900"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-152"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Context var -&gt; Maybe LocationInfo
forall var. Context var -&gt; Maybe LocationInfo
</span><a href="Rzk.TypeCheck.html#location"><span class="hs-identifier hs-var">location</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeErrorInContext var -&gt; Context var
forall var. TypeErrorInContext var -&gt; Context var
</span><a href="Rzk.TypeCheck.html#typeErrorContext"><span class="hs-identifier hs-var">typeErrorContext</span></a></span><span> </span><span class="annot"><span class="annottext">TypeErrorInContext var
</span><a href="#local-6989586621679734900"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe LocationInfo
-&gt; (LocationInfo -&gt; Maybe FilePath) -&gt; Maybe FilePath
forall a b. Maybe a -&gt; (a -&gt; Maybe b) -&gt; Maybe b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">LocationInfo -&gt; Maybe FilePath
</span><a href="Rzk.TypeCheck.html#locationFilePath"><span class="hs-identifier hs-var">locationFilePath</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-153"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679734904"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734904"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734904"><span class="hs-identifier hs-var">path</span></a></span><span>
</span><span id="line-154"></span><span>        </span><span class="annot"><span class="annottext">Maybe FilePath
</span><span class="hs-identifier">_</span></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath
forall a. HasCallStack =&gt; FilePath -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;the impossible happened! Please contact Abdelrahman immediately!!!&quot;</span></span><span>
</span><span id="line-155"></span><span>    </span><span class="annot"><a href="#local-6989586621679734892"><span class="hs-identifier hs-var">filepathOfTypeError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rzk.TypeCheck.html#ScopedTypeError"><span class="hs-identifier hs-type">ScopedTypeError</span></a></span><span> </span><span id="local-6989586621679734907"><span class="annot"><span class="annottext">Maybe VarIdent
</span><a href="#local-6989586621679734907"><span class="hs-identifier hs-var">_orig</span></a></span></span><span> </span><span id="local-6989586621679734908"><span class="annot"><span class="annottext">TypeErrorInScopedContext (Inc var)
</span><a href="#local-6989586621679734908"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeErrorInScopedContext (Inc var) -&gt; FilePath
forall var. TypeErrorInScopedContext var -&gt; FilePath
</span><a href="#local-6989586621679734892"><span class="hs-identifier hs-var">filepathOfTypeError</span></a></span><span> </span><span class="annot"><span class="annottext">TypeErrorInScopedContext (Inc var)
</span><a href="#local-6989586621679734908"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span>    </span><span class="annot"><a href="#local-6989586621679734894"><span class="hs-identifier hs-type">diagnosticOfTypeError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Rzk.TypeCheck.html#TypeErrorInScopedContext"><span class="hs-identifier hs-type">TypeErrorInScopedContext</span></a></span><span> </span><span class="annot"><a href="Language.Rzk.Free.Syntax.html#VarIdent"><span class="hs-identifier hs-type">VarIdent</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Diagnostic</span></span><span>
</span><span id="line-158"></span><span>    </span><span id="local-6989586621679734894"><span class="annot"><span class="annottext">diagnosticOfTypeError :: TypeErrorInScopedContext VarIdent -&gt; Diagnostic
</span><a href="#local-6989586621679734894"><span class="hs-identifier hs-var hs-var">diagnosticOfTypeError</span></a></span></span><span> </span><span id="local-6989586621679734909"><span class="annot"><span class="annottext">TypeErrorInScopedContext VarIdent
</span><a href="#local-6989586621679734909"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Range
-&gt; Maybe DiagnosticSeverity
-&gt; Maybe (Int32 |? Text)
-&gt; Maybe CodeDescription
-&gt; Maybe Text
-&gt; Text
-&gt; Maybe [DiagnosticTag]
-&gt; Maybe [DiagnosticRelatedInformation]
-&gt; Maybe Value
-&gt; Diagnostic
</span><span class="hs-identifier hs-var">Diagnostic</span></span><span>
</span><span id="line-159"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Position -&gt; Position -&gt; Range
</span><span class="hs-identifier hs-var">Range</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInt -&gt; UInt -&gt; Position
</span><span class="hs-identifier hs-var">Position</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679734913"><span class="hs-identifier hs-var">line</span></a></span><span> </span><span class="annot"><span class="annottext">UInt
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInt -&gt; UInt -&gt; Position
</span><span class="hs-identifier hs-var">Position</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679734913"><span class="hs-identifier hs-var">line</span></a></span><span> </span><span class="annot"><span class="annottext">UInt
</span><span class="hs-number">99</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- 99 to reach end of line and be visible until we actually have information about it</span><span>
</span><span id="line-160"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiagnosticSeverity -&gt; Maybe DiagnosticSeverity
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DiagnosticSeverity
</span><span class="hs-identifier hs-var">DiagnosticSeverity_Error</span></span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int32 |? Text) -&gt; Maybe (Int32 |? Text)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">((Int32 |? Text) -&gt; Maybe (Int32 |? Text))
-&gt; (Int32 |? Text) -&gt; Maybe (Int32 |? Text)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Int32 |? Text
forall a b. b -&gt; a |? b
</span><span class="hs-identifier hs-var">InR</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;type-error&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- diagnostic code</span><span>
</span><span id="line-162"></span><span>                      </span><span class="annot"><span class="annottext">Maybe CodeDescription
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                   </span><span class="hs-comment">-- diagonstic description</span><span>
</span><span id="line-163"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;rzk&quot;</span></span><span class="hs-special">)</span><span>              </span><span class="hs-comment">-- A human-readable string describing the source of this diagnostic</span><span>
</span><span id="line-164"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734917"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>                      </span><span class="annot"><span class="annottext">Maybe [DiagnosticTag]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                   </span><span class="hs-comment">-- tags</span><span>
</span><span id="line-166"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DiagnosticRelatedInformation]
-&gt; Maybe [DiagnosticRelatedInformation]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>                 </span><span class="hs-comment">-- related information</span><span>
</span><span id="line-167"></span><span>                      </span><span class="annot"><span class="annottext">Maybe Value
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                   </span><span class="hs-comment">-- data that is preserved between different calls</span><span>
</span><span id="line-168"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-169"></span><span>        </span><span id="local-6989586621679734917"><span class="annot"><span class="annottext">msg :: FilePath
</span><a href="#local-6989586621679734917"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutputDirection -&gt; TypeErrorInScopedContext VarIdent -&gt; FilePath
</span><a href="Rzk.TypeCheck.html#ppTypeErrorInScopedContext%27"><span class="hs-identifier hs-var">ppTypeErrorInScopedContext'</span></a></span><span> </span><span class="annot"><span class="annottext">OutputDirection
</span><a href="Rzk.TypeCheck.html#TopDown"><span class="hs-identifier hs-var">TopDown</span></a></span><span> </span><span class="annot"><span class="annottext">TypeErrorInScopedContext VarIdent
</span><a href="#local-6989586621679734909"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span>        </span><span id="local-6989586621679734351"><span class="annot"><a href="#local-6989586621679734919"><span class="hs-identifier hs-type">extractLineNumber</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Rzk.TypeCheck.html#TypeErrorInScopedContext"><span class="hs-identifier hs-type">TypeErrorInScopedContext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679734351"><span class="hs-identifier hs-type">var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span></span><span>
</span><span id="line-172"></span><span>        </span><span id="local-6989586621679734919"><span class="annot"><span class="annottext">extractLineNumber :: forall var. TypeErrorInScopedContext var -&gt; Maybe Int
</span><a href="#local-6989586621679734919"><span class="hs-identifier hs-var hs-var">extractLineNumber</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rzk.TypeCheck.html#PlainTypeError"><span class="hs-identifier hs-type">PlainTypeError</span></a></span><span> </span><span id="local-6989586621679734925"><span class="annot"><span class="annottext">TypeErrorInContext var
</span><a href="#local-6989586621679734925"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-173"></span><span>          </span><span id="local-6989586621679734926"><span class="annot"><span class="annottext">LocationInfo
</span><a href="#local-6989586621679734926"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context var -&gt; Maybe LocationInfo
forall var. Context var -&gt; Maybe LocationInfo
</span><a href="Rzk.TypeCheck.html#location"><span class="hs-identifier hs-var">location</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeErrorInContext var -&gt; Context var
forall var. TypeErrorInContext var -&gt; Context var
</span><a href="Rzk.TypeCheck.html#typeErrorContext"><span class="hs-identifier hs-var">typeErrorContext</span></a></span><span> </span><span class="annot"><span class="annottext">TypeErrorInContext var
</span><a href="#local-6989586621679734925"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>          </span><span id="local-6989586621679734927"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679734927"><span class="hs-identifier hs-var">lineNo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LocationInfo -&gt; Maybe Int
</span><a href="Rzk.TypeCheck.html#locationLine"><span class="hs-identifier hs-var">locationLine</span></a></span><span> </span><span class="annot"><span class="annottext">LocationInfo
</span><a href="#local-6989586621679734926"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-175"></span><span>          </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679734927"><span class="hs-identifier hs-var">lineNo</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- VS Code indexes lines from 0, but locationLine starts with 1</span><span>
</span><span id="line-176"></span><span>        </span><span class="annot"><a href="#local-6989586621679734919"><span class="hs-identifier hs-var">extractLineNumber</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rzk.TypeCheck.html#ScopedTypeError"><span class="hs-identifier hs-type">ScopedTypeError</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe VarIdent
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679734929"><span class="annot"><span class="annottext">TypeErrorInScopedContext (Inc var)
</span><a href="#local-6989586621679734929"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeErrorInScopedContext (Inc var) -&gt; Maybe Int
forall var. TypeErrorInScopedContext var -&gt; Maybe Int
</span><a href="#local-6989586621679734919"><span class="hs-identifier hs-var">extractLineNumber</span></a></span><span> </span><span class="annot"><span class="annottext">TypeErrorInScopedContext (Inc var)
</span><a href="#local-6989586621679734929"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span>        </span><span id="local-6989586621679734913"><span class="annot"><span class="annottext">line :: UInt
</span><a href="#local-6989586621679734913"><span class="hs-identifier hs-var hs-var">line</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; UInt
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; UInt) -&gt; Int -&gt; UInt
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int -&gt; Int
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Int -&gt; Int) -&gt; Maybe Int -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeErrorInScopedContext VarIdent -&gt; Maybe Int
forall var. TypeErrorInScopedContext var -&gt; Maybe Int
</span><a href="#local-6989586621679734919"><span class="hs-identifier hs-var">extractLineNumber</span></a></span><span> </span><span class="annot"><span class="annottext">TypeErrorInScopedContext VarIdent
</span><a href="#local-6989586621679734909"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span>    </span><span class="annot"><a href="#local-6989586621679734889"><span class="hs-identifier hs-type">diagnosticOfParseError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Diagnostic</span></span><span>
</span><span id="line-181"></span><span>    </span><span id="local-6989586621679734889"><span class="annot"><span class="annottext">diagnosticOfParseError :: FilePath -&gt; Diagnostic
</span><a href="#local-6989586621679734889"><span class="hs-identifier hs-var hs-var">diagnosticOfParseError</span></a></span></span><span> </span><span id="local-6989586621679734932"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734932"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Range
-&gt; Maybe DiagnosticSeverity
-&gt; Maybe (Int32 |? Text)
-&gt; Maybe CodeDescription
-&gt; Maybe Text
-&gt; Text
-&gt; Maybe [DiagnosticTag]
-&gt; Maybe [DiagnosticRelatedInformation]
-&gt; Maybe Value
-&gt; Diagnostic
</span><span class="hs-identifier hs-var">Diagnostic</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Position -&gt; Position -&gt; Range
</span><span class="hs-identifier hs-var">Range</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInt -&gt; UInt -&gt; Position
</span><span class="hs-identifier hs-var">Position</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInt -&gt; UInt -&gt; Position
</span><span class="hs-identifier hs-var">Position</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiagnosticSeverity -&gt; Maybe DiagnosticSeverity
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DiagnosticSeverity
</span><span class="hs-identifier hs-var">DiagnosticSeverity_Error</span></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int32 |? Text) -&gt; Maybe (Int32 |? Text)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">((Int32 |? Text) -&gt; Maybe (Int32 |? Text))
-&gt; (Int32 |? Text) -&gt; Maybe (Int32 |? Text)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Int32 |? Text
forall a b. b -&gt; a |? b
</span><span class="hs-identifier hs-var">InR</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;parse-error&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span>                      </span><span class="annot"><span class="annottext">Maybe CodeDescription
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-185"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;rzk&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679734932"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-187"></span><span>                      </span><span class="annot"><span class="annottext">Maybe [DiagnosticTag]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-188"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DiagnosticRelatedInformation]
-&gt; Maybe [DiagnosticRelatedInformation]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>                      </span><span class="annot"><span class="annottext">Maybe Value
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Default</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679734937"><span class="annot"><span class="annottext">def :: Text
</span><a href="#local-6989586621679734937"><span class="hs-identifier hs-var hs-var hs-var hs-var">def</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-192"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679734940"><span class="annot"><span class="hs-identifier hs-type">Default</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CompletionItem</span></span></span><span>
</span><span id="line-193"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679735017"><span class="annot"><span class="hs-identifier hs-type">Default</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CompletionItemLabelDetails</span></span></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#provideCompletions"><span class="hs-identifier hs-type">provideCompletions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handler</span></span><span> </span><span class="annot"><a href="Language.Rzk.VSCode.Env.html#LSP"><span class="hs-identifier hs-type">LSP</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">Method_TextDocumentCompletion</span></span><span>
</span><span id="line-196"></span><span id="provideCompletions"><span class="annot"><span class="annottext">provideCompletions :: Handler
  (LspT ServerConfig (ReaderT RzkEnv IO))
  'Method_TextDocumentCompletion
</span><a href="Language.Rzk.VSCode.Handlers.html#provideCompletions"><span class="hs-identifier hs-var hs-var">provideCompletions</span></a></span></span><span> </span><span id="local-6989586621679735030"><span class="annot"><span class="annottext">TRequestMessage 'Method_TextDocumentCompletion
</span><a href="#local-6989586621679735030"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span id="local-6989586621679735031"><span class="annot"><span class="annottext">Either ResponseError ([CompletionItem] |? (CompletionList |? Null))
-&gt; LSP ()
</span><a href="#local-6989586621679735031"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-197"></span><span>  </span><span class="annot"><span class="annottext">FilePath -&gt; LSP ()
forall c (m :: * -&gt; *). MonadLsp c m =&gt; FilePath -&gt; m ()
</span><a href="Language.Rzk.VSCode.Logging.html#logInfo"><span class="hs-identifier hs-var">logInfo</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Providing text completions&quot;</span></span><span>
</span><span id="line-198"></span><span>  </span><span id="local-6989586621679735032"><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="#local-6989586621679735032"><span class="hs-identifier hs-var">root</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LspT ServerConfig (ReaderT RzkEnv IO) (Maybe FilePath)
forall config (m :: * -&gt; *).
MonadLsp config m =&gt;
m (Maybe FilePath)
</span><span class="hs-identifier hs-var">getRootPath</span></span><span>
</span><span id="line-199"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; LSP () -&gt; LSP ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe FilePath -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="#local-6989586621679735032"><span class="hs-identifier hs-var">root</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(LSP () -&gt; LSP ()) -&gt; LSP () -&gt; LSP ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; LSP ()
forall c (m :: * -&gt; *). MonadLsp c m =&gt; FilePath -&gt; m ()
</span><a href="Language.Rzk.VSCode.Logging.html#logDebug"><span class="hs-identifier hs-var">logDebug</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Not in a workspace. Cannot find root path for relative paths&quot;</span></span><span>
</span><span id="line-200"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679735035"><span class="annot"><span class="annottext">rootDir :: FilePath
</span><a href="#local-6989586621679735035"><span class="hs-identifier hs-var hs-var">rootDir</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Maybe FilePath -&gt; FilePath
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;/&quot;</span></span><span> </span><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="#local-6989586621679735032"><span class="hs-identifier hs-var">root</span></a></span><span>
</span><span id="line-201"></span><span>  </span><span id="local-6989586621679735036"><span class="annot"><span class="annottext">RzkTypecheckCache
</span><a href="#local-6989586621679735036"><span class="hs-identifier hs-var">cachedModules</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LSP RzkTypecheckCache
</span><a href="Language.Rzk.VSCode.Env.html#getCachedTypecheckedModules"><span class="hs-identifier hs-var">getCachedTypecheckedModules</span></a></span><span>
</span><span id="line-202"></span><span>  </span><span class="annot"><span class="annottext">FilePath -&gt; LSP ()
forall c (m :: * -&gt; *). MonadLsp c m =&gt; FilePath -&gt; m ()
</span><a href="Language.Rzk.VSCode.Logging.html#logDebug"><span class="hs-identifier hs-var">logDebug</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Found &quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RzkTypecheckCache -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">RzkTypecheckCache
</span><a href="#local-6989586621679735036"><span class="hs-identifier hs-var">cachedModules</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot; modules in the cache&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679735051"><span class="annot"><span class="annottext">currentFile :: FilePath
</span><a href="#local-6989586621679735051"><span class="hs-identifier hs-var hs-var">currentFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Maybe FilePath -&gt; FilePath
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe FilePath -&gt; FilePath) -&gt; Maybe FilePath -&gt; FilePath
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Uri -&gt; Maybe FilePath
</span><span class="hs-identifier hs-var">uriToFilePath</span></span><span> </span><span class="annot"><span class="annottext">(Uri -&gt; Maybe FilePath) -&gt; Uri -&gt; Maybe FilePath
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TRequestMessage 'Method_TextDocumentCompletion
</span><a href="#local-6989586621679735030"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">TRequestMessage 'Method_TextDocumentCompletion
-&gt; Getting Uri (TRequestMessage 'Method_TextDocumentCompletion) Uri
-&gt; Uri
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">(CompletionParams -&gt; Const Uri CompletionParams)
-&gt; TRequestMessage 'Method_TextDocumentCompletion
-&gt; Const Uri (TRequestMessage 'Method_TextDocumentCompletion)
forall s a. HasParams s a =&gt; Lens' s a
Lens'
  (TRequestMessage 'Method_TextDocumentCompletion) CompletionParams
</span><span class="hs-identifier hs-var">params</span></span><span> </span><span class="annot"><span class="annottext">((CompletionParams -&gt; Const Uri CompletionParams)
 -&gt; TRequestMessage 'Method_TextDocumentCompletion
 -&gt; Const Uri (TRequestMessage 'Method_TextDocumentCompletion))
-&gt; ((Uri -&gt; Const Uri Uri)
    -&gt; CompletionParams -&gt; Const Uri CompletionParams)
-&gt; Getting Uri (TRequestMessage 'Method_TextDocumentCompletion) Uri
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(TextDocumentIdentifier -&gt; Const Uri TextDocumentIdentifier)
-&gt; CompletionParams -&gt; Const Uri CompletionParams
forall s a. HasTextDocument s a =&gt; Lens' s a
Lens' CompletionParams TextDocumentIdentifier
</span><span class="hs-identifier hs-var">textDocument</span></span><span> </span><span class="annot"><span class="annottext">((TextDocumentIdentifier -&gt; Const Uri TextDocumentIdentifier)
 -&gt; CompletionParams -&gt; Const Uri CompletionParams)
-&gt; ((Uri -&gt; Const Uri Uri)
    -&gt; TextDocumentIdentifier -&gt; Const Uri TextDocumentIdentifier)
-&gt; (Uri -&gt; Const Uri Uri)
-&gt; CompletionParams
-&gt; Const Uri CompletionParams
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Uri -&gt; Const Uri Uri)
-&gt; TextDocumentIdentifier -&gt; Const Uri TextDocumentIdentifier
forall s a. HasUri s a =&gt; Lens' s a
Lens' TextDocumentIdentifier Uri
</span><span class="hs-identifier hs-var">uri</span></span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-comment">-- Take all the modules up to and including the currently open one</span><span>
</span><span id="line-205"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679735056"><span class="annot"><span class="annottext">modules :: RzkTypecheckCache
</span><a href="#local-6989586621679735056"><span class="hs-identifier hs-var hs-var">modules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((FilePath, [Decl']) -&gt; Bool)
-&gt; RzkTypecheckCache -&gt; RzkTypecheckCache
forall {a}. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="#local-6989586621679735057"><span class="hs-identifier hs-var">takeWhileInc</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735051"><span class="hs-identifier hs-var">currentFile</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; Bool)
-&gt; ((FilePath, [Decl']) -&gt; FilePath) -&gt; (FilePath, [Decl']) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(FilePath, [Decl']) -&gt; FilePath
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RzkTypecheckCache
</span><a href="#local-6989586621679735036"><span class="hs-identifier hs-var">cachedModules</span></a></span><span>
</span><span id="line-206"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-207"></span><span>          </span><span id="local-6989586621679735057"><span class="annot"><span class="annottext">takeWhileInc :: (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="#local-6989586621679735057"><span class="hs-identifier hs-var hs-var">takeWhileInc</span></a></span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-208"></span><span>          </span><span class="annot"><a href="#local-6989586621679735057"><span class="hs-identifier hs-var">takeWhileInc</span></a></span><span> </span><span id="local-6989586621679735059"><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679735059"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679735060"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679735060"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679735061"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679735061"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679735059"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679735060"><span class="hs-identifier hs-var">x</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679735060"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="#local-6989586621679735057"><span class="hs-identifier hs-var">takeWhileInc</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679735059"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679735061"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-210"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679735060"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-211"></span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679735063"><span class="annot"><span class="annottext">items :: [CompletionItem]
</span><a href="#local-6989586621679735063"><span class="hs-identifier hs-var hs-var">items</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((FilePath, [Decl']) -&gt; [CompletionItem])
-&gt; RzkTypecheckCache -&gt; [CompletionItem]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; (FilePath, [Decl']) -&gt; [CompletionItem]
</span><a href="#local-6989586621679735064"><span class="hs-identifier hs-var">declsToItems</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735035"><span class="hs-identifier hs-var">rootDir</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RzkTypecheckCache
</span><a href="#local-6989586621679735056"><span class="hs-identifier hs-var">modules</span></a></span><span>
</span><span id="line-213"></span><span>  </span><span class="annot"><span class="annottext">FilePath -&gt; LSP ()
forall c (m :: * -&gt; *). MonadLsp c m =&gt; FilePath -&gt; m ()
</span><a href="Language.Rzk.VSCode.Logging.html#logDebug"><span class="hs-identifier hs-var">logDebug</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Sending &quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CompletionItem] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[CompletionItem]
</span><a href="#local-6989586621679735063"><span class="hs-identifier hs-var">items</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot; completion items&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>  </span><span class="annot"><span class="annottext">Either ResponseError ([CompletionItem] |? (CompletionList |? Null))
-&gt; LSP ()
</span><a href="#local-6989586621679735031"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">(Either
   ResponseError ([CompletionItem] |? (CompletionList |? Null))
 -&gt; LSP ())
-&gt; Either
     ResponseError ([CompletionItem] |? (CompletionList |? Null))
-&gt; LSP ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([CompletionItem] |? (CompletionList |? Null))
-&gt; Either
     ResponseError ([CompletionItem] |? (CompletionList |? Null))
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(([CompletionItem] |? (CompletionList |? Null))
 -&gt; Either
      ResponseError ([CompletionItem] |? (CompletionList |? Null)))
-&gt; ([CompletionItem] |? (CompletionList |? Null))
-&gt; Either
     ResponseError ([CompletionItem] |? (CompletionList |? Null))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[CompletionItem] -&gt; [CompletionItem] |? (CompletionList |? Null)
forall a b. a -&gt; a |? b
</span><span class="hs-identifier hs-var">InL</span></span><span> </span><span class="annot"><span class="annottext">[CompletionItem]
</span><a href="#local-6989586621679735063"><span class="hs-identifier hs-var">items</span></a></span><span>
</span><span id="line-215"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-216"></span><span>    </span><span class="annot"><a href="#local-6989586621679735064"><span class="hs-identifier hs-type">declsToItems</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Rzk.TypeCheck.html#Decl%27"><span class="hs-identifier hs-type">Decl'</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">CompletionItem</span></span><span class="hs-special">]</span><span>
</span><span id="line-217"></span><span>    </span><span id="local-6989586621679735064"><span class="annot"><span class="annottext">declsToItems :: FilePath -&gt; (FilePath, [Decl']) -&gt; [CompletionItem]
</span><a href="#local-6989586621679735064"><span class="hs-identifier hs-var hs-var">declsToItems</span></a></span></span><span> </span><span id="local-6989586621679735066"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735066"><span class="hs-identifier hs-var">root</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679735067"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735067"><span class="hs-identifier hs-var">path</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679735068"><span class="annot"><span class="annottext">[Decl']
</span><a href="#local-6989586621679735068"><span class="hs-identifier hs-var">decls</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Decl' -&gt; CompletionItem) -&gt; [Decl'] -&gt; [CompletionItem]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; Decl' -&gt; CompletionItem
</span><a href="#local-6989586621679735069"><span class="hs-identifier hs-var">declToItem</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735066"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735067"><span class="hs-identifier hs-var">path</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Decl']
</span><a href="#local-6989586621679735068"><span class="hs-identifier hs-var">decls</span></a></span><span>
</span><span id="line-218"></span><span>    </span><span class="annot"><a href="#local-6989586621679735069"><span class="hs-identifier hs-type">declToItem</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Rzk.TypeCheck.html#Decl%27"><span class="hs-identifier hs-type">Decl'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CompletionItem</span></span><span>
</span><span id="line-219"></span><span>    </span><span id="local-6989586621679735069"><span class="annot"><span class="annottext">declToItem :: FilePath -&gt; FilePath -&gt; Decl' -&gt; CompletionItem
</span><a href="#local-6989586621679735069"><span class="hs-identifier hs-var hs-var">declToItem</span></a></span></span><span> </span><span id="local-6989586621679735070"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735070"><span class="hs-identifier hs-var">rootDir</span></a></span></span><span> </span><span id="local-6989586621679735071"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735071"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rzk.TypeCheck.html#Decl"><span class="hs-identifier hs-type">Decl</span></a></span><span> </span><span id="local-6989586621679735073"><span class="annot"><span class="annottext">VarIdent
</span><a href="#local-6989586621679735073"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679735074"><span class="annot"><span class="annottext">TermT VarIdent
</span><a href="#local-6989586621679735074"><span class="hs-identifier hs-var">type'</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe (TermT VarIdent)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[VarIdent]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CompletionItem
forall a. Default a =&gt; a
</span><span class="hs-identifier hs-var">def</span></span><span>
</span><span id="line-220"></span><span>      </span><span class="annot"><span class="annottext">CompletionItem
-&gt; (CompletionItem -&gt; CompletionItem) -&gt; CompletionItem
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Identity Text)
-&gt; CompletionItem -&gt; Identity CompletionItem
forall s a. HasLabel s a =&gt; Lens' s a
Lens' CompletionItem Text
</span><span class="hs-keyword hs-var">label</span></span><span> </span><span class="annot"><span class="annottext">((Text -&gt; Identity Text)
 -&gt; CompletionItem -&gt; Identity CompletionItem)
-&gt; Text -&gt; CompletionItem -&gt; CompletionItem
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarIdent' RzkPosition -&gt; FilePath
forall a. Print a =&gt; a -&gt; FilePath
</span><a href="Language.Rzk.Syntax.html#printTree"><span class="hs-identifier hs-var">printTree</span></a></span><span> </span><span class="annot"><span class="annottext">(VarIdent' RzkPosition -&gt; FilePath)
-&gt; VarIdent' RzkPosition -&gt; FilePath
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VarIdent -&gt; VarIdent' RzkPosition
</span><a href="Language.Rzk.Free.Syntax.html#getVarIdent"><span class="hs-identifier hs-var">getVarIdent</span></a></span><span> </span><span class="annot"><span class="annottext">VarIdent
</span><a href="#local-6989586621679735073"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>      </span><span class="annot"><span class="annottext">CompletionItem
-&gt; (CompletionItem -&gt; CompletionItem) -&gt; CompletionItem
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Text -&gt; Identity (Maybe Text))
-&gt; CompletionItem -&gt; Identity CompletionItem
forall s a. HasDetail s a =&gt; Lens' s a
Lens' CompletionItem (Maybe Text)
</span><span class="hs-identifier hs-var">detail</span></span><span> </span><span class="annot"><span class="annottext">((Maybe Text -&gt; Identity (Maybe Text))
 -&gt; CompletionItem -&gt; Identity CompletionItem)
-&gt; Text -&gt; CompletionItem -&gt; CompletionItem
forall s t a b. ASetter s t a (Maybe b) -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">?~</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TermT VarIdent -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">TermT VarIdent
</span><a href="#local-6989586621679735074"><span class="hs-identifier hs-var">type'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>      </span><span class="annot"><span class="annottext">CompletionItem
-&gt; (CompletionItem -&gt; CompletionItem) -&gt; CompletionItem
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Text |? MarkupContent)
 -&gt; Identity (Maybe (Text |? MarkupContent)))
-&gt; CompletionItem -&gt; Identity CompletionItem
forall s a. HasDocumentation s a =&gt; Lens' s a
Lens' CompletionItem (Maybe (Text |? MarkupContent))
</span><span class="hs-identifier hs-var">documentation</span></span><span> </span><span class="annot"><span class="annottext">((Maybe (Text |? MarkupContent)
  -&gt; Identity (Maybe (Text |? MarkupContent)))
 -&gt; CompletionItem -&gt; Identity CompletionItem)
-&gt; (Text |? MarkupContent) -&gt; CompletionItem -&gt; CompletionItem
forall s t a b. ASetter s t a (Maybe b) -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">?~</span></span><span> </span><span class="annot"><span class="annottext">MarkupContent -&gt; Text |? MarkupContent
forall a b. b -&gt; a |? b
</span><span class="hs-identifier hs-var">InR</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MarkupKind -&gt; Text -&gt; MarkupContent
</span><span class="hs-identifier hs-var">MarkupContent</span></span><span> </span><span class="annot"><span class="annottext">MarkupKind
</span><span class="hs-identifier hs-var">MarkupKind_Markdown</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; MarkupContent) -&gt; Text -&gt; MarkupContent
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; Text) -&gt; FilePath -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-223"></span><span>          </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;---\nDefined&quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-224"></span><span>          </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679735080"><span class="hs-identifier hs-var">line</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot; at line &quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679735080"><span class="hs-identifier hs-var">line</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>          </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot; in *&quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
</span><span class="hs-identifier hs-var">makeRelative</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735070"><span class="hs-identifier hs-var">rootDir</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735071"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;*&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-226"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-227"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Language.Rzk.Syntax.Abs.html#VarIdent"><span class="hs-identifier hs-type">VarIdent</span></a></span><span> </span><span id="local-6989586621679735082"><span class="annot"><span class="annottext">RzkPosition
</span><a href="#local-6989586621679735082"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span class="annot"><span class="annottext">VarIdentToken
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarIdent -&gt; VarIdent' RzkPosition
</span><a href="Language.Rzk.Free.Syntax.html#getVarIdent"><span class="hs-identifier hs-var">getVarIdent</span></a></span><span> </span><span class="annot"><span class="annottext">VarIdent
</span><a href="#local-6989586621679735073"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-228"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Language.Rzk.Free.Syntax.html#RzkPosition"><span class="hs-identifier hs-type">RzkPosition</span></a></span><span> </span><span id="local-6989586621679735083"><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="#local-6989586621679735083"><span class="hs-identifier hs-var">_path</span></a></span></span><span> </span><span id="local-6989586621679735084"><span class="annot"><span class="annottext">BNFC'Position
</span><a href="#local-6989586621679735084"><span class="hs-identifier hs-var">pos'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RzkPosition
</span><a href="#local-6989586621679735082"><span class="hs-identifier hs-var">pos</span></a></span><span>
</span><span id="line-229"></span><span>        </span><span id="local-6989586621679735080"><span class="annot"><span class="annottext">line :: Int
</span><a href="#local-6989586621679735080"><span class="hs-identifier hs-var hs-var">line</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ((Int, Int) -&gt; Int) -&gt; BNFC'Position -&gt; Int
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">(Int, Int) -&gt; Int
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">BNFC'Position
</span><a href="#local-6989586621679735084"><span class="hs-identifier hs-var">pos'</span></a></span><span>
</span><span id="line-230"></span><span>        </span><span id="local-6989586621679735088"><span class="annot"><span class="annottext">_col :: Int
</span><a href="#local-6989586621679735088"><span class="hs-identifier hs-var hs-var">_col</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ((Int, Int) -&gt; Int) -&gt; BNFC'Position -&gt; Int
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">(Int, Int) -&gt; Int
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">BNFC'Position
</span><a href="#local-6989586621679735084"><span class="hs-identifier hs-var">pos'</span></a></span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#formattingEditToTextEdit"><span class="hs-identifier hs-type">formattingEditToTextEdit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Rzk.Format.html#FormattingEdit"><span class="hs-identifier hs-type">FormattingEdit</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TextEdit</span></span><span>
</span><span id="line-233"></span><span id="formattingEditToTextEdit"><span class="annot"><span class="annottext">formattingEditToTextEdit :: FormattingEdit -&gt; TextEdit
</span><a href="Language.Rzk.VSCode.Handlers.html#formattingEditToTextEdit"><span class="hs-identifier hs-var hs-var">formattingEditToTextEdit</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Rzk.Format.html#FormattingEdit"><span class="hs-identifier hs-type">FormattingEdit</span></a></span><span> </span><span id="local-6989586621679735092"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679735092"><span class="hs-identifier hs-var">startLine</span></a></span></span><span> </span><span id="local-6989586621679735093"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679735093"><span class="hs-identifier hs-var">startCol</span></a></span></span><span> </span><span id="local-6989586621679735094"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679735094"><span class="hs-identifier hs-var">endLine</span></a></span></span><span> </span><span id="local-6989586621679735095"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679735095"><span class="hs-identifier hs-var">endCol</span></a></span></span><span> </span><span id="local-6989586621679735096"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735096"><span class="hs-identifier hs-var">newText</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-234"></span><span>  </span><span class="annot"><span class="annottext">Range -&gt; Text -&gt; TextEdit
</span><span class="hs-identifier hs-var">TextEdit</span></span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Position -&gt; Position -&gt; Range
</span><span class="hs-identifier hs-var">Range</span></span><span>
</span><span id="line-236"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInt -&gt; UInt -&gt; Position
</span><span class="hs-identifier hs-var">Position</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; UInt
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679735092"><span class="hs-identifier hs-var">startLine</span></a></span><span> </span><span class="annot"><span class="annottext">UInt -&gt; UInt -&gt; UInt
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; UInt
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679735093"><span class="hs-identifier hs-var">startCol</span></a></span><span> </span><span class="annot"><span class="annottext">UInt -&gt; UInt -&gt; UInt
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInt -&gt; UInt -&gt; Position
</span><span class="hs-identifier hs-var">Position</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; UInt
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679735094"><span class="hs-identifier hs-var">endLine</span></a></span><span> </span><span class="annot"><span class="annottext">UInt -&gt; UInt -&gt; UInt
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; UInt
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679735095"><span class="hs-identifier hs-var">endCol</span></a></span><span> </span><span class="annot"><span class="annottext">UInt -&gt; UInt -&gt; UInt
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735096"><span class="hs-identifier hs-var">newText</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#formatDocument"><span class="hs-identifier hs-type">formatDocument</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handler</span></span><span> </span><span class="annot"><a href="Language.Rzk.VSCode.Env.html#LSP"><span class="hs-identifier hs-type">LSP</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">Method_TextDocumentFormatting</span></span><span>
</span><span id="line-242"></span><span id="formatDocument"><span class="annot"><span class="annottext">formatDocument :: Handler
  (LspT ServerConfig (ReaderT RzkEnv IO))
  'Method_TextDocumentFormatting
</span><a href="Language.Rzk.VSCode.Handlers.html#formatDocument"><span class="hs-identifier hs-var hs-var">formatDocument</span></a></span></span><span> </span><span id="local-6989586621679735098"><span class="annot"><span class="annottext">TRequestMessage 'Method_TextDocumentFormatting
</span><a href="#local-6989586621679735098"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span id="local-6989586621679735099"><span class="annot"><span class="annottext">Either ResponseError ([TextEdit] |? Null) -&gt; LSP ()
</span><a href="#local-6989586621679735099"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-243"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679735113"><span class="annot"><span class="annottext">doc :: NormalizedUri
</span><a href="#local-6989586621679735113"><span class="hs-identifier hs-var hs-var">doc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TRequestMessage 'Method_TextDocumentFormatting
</span><a href="#local-6989586621679735098"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">TRequestMessage 'Method_TextDocumentFormatting
-&gt; Getting
     NormalizedUri
     (TRequestMessage 'Method_TextDocumentFormatting)
     NormalizedUri
-&gt; NormalizedUri
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">(DocumentFormattingParams
 -&gt; Const NormalizedUri DocumentFormattingParams)
-&gt; TRequestMessage 'Method_TextDocumentFormatting
-&gt; Const
     NormalizedUri (TRequestMessage 'Method_TextDocumentFormatting)
forall s a. HasParams s a =&gt; Lens' s a
Lens'
  (TRequestMessage 'Method_TextDocumentFormatting)
  DocumentFormattingParams
</span><span class="hs-identifier hs-var">params</span></span><span> </span><span class="annot"><span class="annottext">((DocumentFormattingParams
  -&gt; Const NormalizedUri DocumentFormattingParams)
 -&gt; TRequestMessage 'Method_TextDocumentFormatting
 -&gt; Const
      NormalizedUri (TRequestMessage 'Method_TextDocumentFormatting))
-&gt; ((NormalizedUri -&gt; Const NormalizedUri NormalizedUri)
    -&gt; DocumentFormattingParams
    -&gt; Const NormalizedUri DocumentFormattingParams)
-&gt; Getting
     NormalizedUri
     (TRequestMessage 'Method_TextDocumentFormatting)
     NormalizedUri
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(TextDocumentIdentifier
 -&gt; Const NormalizedUri TextDocumentIdentifier)
-&gt; DocumentFormattingParams
-&gt; Const NormalizedUri DocumentFormattingParams
forall s a. HasTextDocument s a =&gt; Lens' s a
Lens' DocumentFormattingParams TextDocumentIdentifier
</span><span class="hs-identifier hs-var">textDocument</span></span><span> </span><span class="annot"><span class="annottext">((TextDocumentIdentifier
  -&gt; Const NormalizedUri TextDocumentIdentifier)
 -&gt; DocumentFormattingParams
 -&gt; Const NormalizedUri DocumentFormattingParams)
-&gt; ((NormalizedUri -&gt; Const NormalizedUri NormalizedUri)
    -&gt; TextDocumentIdentifier
    -&gt; Const NormalizedUri TextDocumentIdentifier)
-&gt; (NormalizedUri -&gt; Const NormalizedUri NormalizedUri)
-&gt; DocumentFormattingParams
-&gt; Const NormalizedUri DocumentFormattingParams
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Uri -&gt; Const NormalizedUri Uri)
-&gt; TextDocumentIdentifier
-&gt; Const NormalizedUri TextDocumentIdentifier
forall s a. HasUri s a =&gt; Lens' s a
Lens' TextDocumentIdentifier Uri
</span><span class="hs-identifier hs-var">uri</span></span><span> </span><span class="annot"><span class="annottext">((Uri -&gt; Const NormalizedUri Uri)
 -&gt; TextDocumentIdentifier
 -&gt; Const NormalizedUri TextDocumentIdentifier)
-&gt; ((NormalizedUri -&gt; Const NormalizedUri NormalizedUri)
    -&gt; Uri -&gt; Const NormalizedUri Uri)
-&gt; (NormalizedUri -&gt; Const NormalizedUri NormalizedUri)
-&gt; TextDocumentIdentifier
-&gt; Const NormalizedUri TextDocumentIdentifier
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Uri -&gt; NormalizedUri)
-&gt; (NormalizedUri -&gt; Const NormalizedUri NormalizedUri)
-&gt; Uri
-&gt; Const NormalizedUri Uri
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) s a.
(Profunctor p, Contravariant f) =&gt;
(s -&gt; a) -&gt; Optic' p f s a
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">Uri -&gt; NormalizedUri
</span><span class="hs-identifier hs-var">toNormalizedUri</span></span><span>
</span><span id="line-244"></span><span>  </span><span class="annot"><span class="annottext">FilePath -&gt; LSP ()
forall c (m :: * -&gt; *). MonadLsp c m =&gt; FilePath -&gt; m ()
</span><a href="Language.Rzk.VSCode.Logging.html#logInfo"><span class="hs-identifier hs-var">logInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; LSP ()) -&gt; FilePath -&gt; LSP ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Formatting document: &quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679735113"><span class="hs-identifier hs-var">doc</span></a></span><span>
</span><span id="line-245"></span><span>  </span><span class="annot"><a href="Language.Rzk.VSCode.Config.html#ServerConfig"><span class="hs-identifier hs-type">ServerConfig</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">formatEnabled :: ServerConfig -&gt; Bool
</span><a href="Language.Rzk.VSCode.Config.html#formatEnabled"><span class="hs-identifier hs-var">formatEnabled</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679735115"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679735115"><span class="hs-identifier hs-var">fmtEnabled</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LspT ServerConfig (ReaderT RzkEnv IO) ServerConfig
forall config (m :: * -&gt; *). MonadLsp config m =&gt; m config
</span><span class="hs-identifier hs-var">getConfig</span></span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679735115"><span class="hs-identifier hs-var">fmtEnabled</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-247"></span><span>    </span><span id="local-6989586621679735117"><span class="annot"><span class="annottext">Maybe VirtualFile
</span><a href="#local-6989586621679735117"><span class="hs-identifier hs-var">mdoc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NormalizedUri
-&gt; LspT ServerConfig (ReaderT RzkEnv IO) (Maybe VirtualFile)
forall config (m :: * -&gt; *).
MonadLsp config m =&gt;
NormalizedUri -&gt; m (Maybe VirtualFile)
</span><span class="hs-identifier hs-var">getVirtualFile</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679735113"><span class="hs-identifier hs-var">doc</span></a></span><span>
</span><span id="line-248"></span><span>    </span><span id="local-6989586621679735119"><span class="annot"><span class="annottext">Either Text [TextEdit]
</span><a href="#local-6989586621679735119"><span class="hs-identifier hs-var">possibleEdits</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VirtualFile -&gt; Text
</span><span class="hs-identifier hs-var">virtualFileText</span></span><span> </span><span class="annot"><span class="annottext">(VirtualFile -&gt; Text) -&gt; Maybe VirtualFile -&gt; Maybe Text
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe VirtualFile
</span><a href="#local-6989586621679735117"><span class="hs-identifier hs-var">mdoc</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-249"></span><span>      </span><span class="annot"><span class="annottext">Maybe Text
</span><span class="hs-identifier hs-var">Nothing</span></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either Text [TextEdit]
-&gt; LspT ServerConfig (ReaderT RzkEnv IO) (Either Text [TextEdit])
forall a. a -&gt; LspT ServerConfig (ReaderT RzkEnv IO) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Either Text [TextEdit]
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Failed to get file contents&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679735120"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679735120"><span class="hs-identifier hs-var">sourceCode</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-251"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679735122"><span class="annot"><span class="annottext">edits :: [FormattingEdit]
</span><a href="#local-6989586621679735122"><span class="hs-identifier hs-var hs-var">edits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; [FormattingEdit]
</span><a href="Rzk.Format.html#formatTextEdits"><span class="hs-identifier hs-var">formatTextEdits</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; FilePath -&gt; FilePath
forall {a}. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; Char -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'\r'</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; FilePath) -&gt; FilePath -&gt; FilePath
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; FilePath
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679735120"><span class="hs-identifier hs-var">sourceCode</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>        </span><span class="annot"><span class="annottext">Either Text [TextEdit]
-&gt; LspT ServerConfig (ReaderT RzkEnv IO) (Either Text [TextEdit])
forall a. a -&gt; LspT ServerConfig (ReaderT RzkEnv IO) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TextEdit] -&gt; Either Text [TextEdit]
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">([TextEdit] -&gt; Either Text [TextEdit])
-&gt; [TextEdit] -&gt; Either Text [TextEdit]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(FormattingEdit -&gt; TextEdit) -&gt; [FormattingEdit] -&gt; [TextEdit]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">FormattingEdit -&gt; TextEdit
</span><a href="Language.Rzk.VSCode.Handlers.html#formattingEditToTextEdit"><span class="hs-identifier hs-var">formattingEditToTextEdit</span></a></span><span> </span><span class="annot"><span class="annottext">[FormattingEdit]
</span><a href="#local-6989586621679735122"><span class="hs-identifier hs-var">edits</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either Text [TextEdit]
</span><a href="#local-6989586621679735119"><span class="hs-identifier hs-var">possibleEdits</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-254"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679735124"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679735124"><span class="hs-identifier hs-var">err</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either ResponseError ([TextEdit] |? Null) -&gt; LSP ()
</span><a href="#local-6989586621679735099"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ResponseError ([TextEdit] |? Null) -&gt; LSP ())
-&gt; Either ResponseError ([TextEdit] |? Null) -&gt; LSP ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ResponseError -&gt; Either ResponseError ([TextEdit] |? Null)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(ResponseError -&gt; Either ResponseError ([TextEdit] |? Null))
-&gt; ResponseError -&gt; Either ResponseError ([TextEdit] |? Null)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(LSPErrorCodes |? ErrorCodes)
-&gt; Text -&gt; Maybe Value -&gt; ResponseError
</span><span class="hs-identifier hs-var">ResponseError</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ErrorCodes -&gt; LSPErrorCodes |? ErrorCodes
forall a b. b -&gt; a |? b
</span><span class="hs-identifier hs-var">InR</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodes
</span><span class="hs-identifier hs-var">ErrorCodes_InternalError</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679735124"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Value
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-255"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679735127"><span class="annot"><span class="annottext">[TextEdit]
</span><a href="#local-6989586621679735127"><span class="hs-identifier hs-var">edits</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-256"></span><span>        </span><span class="annot"><span class="annottext">Either ResponseError ([TextEdit] |? Null) -&gt; LSP ()
</span><a href="#local-6989586621679735099"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ResponseError ([TextEdit] |? Null) -&gt; LSP ())
-&gt; Either ResponseError ([TextEdit] |? Null) -&gt; LSP ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([TextEdit] |? Null) -&gt; Either ResponseError ([TextEdit] |? Null)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(([TextEdit] |? Null) -&gt; Either ResponseError ([TextEdit] |? Null))
-&gt; ([TextEdit] |? Null)
-&gt; Either ResponseError ([TextEdit] |? Null)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TextEdit] -&gt; [TextEdit] |? Null
forall a b. a -&gt; a |? b
</span><span class="hs-identifier hs-var">InL</span></span><span> </span><span class="annot"><span class="annottext">[TextEdit]
</span><a href="#local-6989586621679735127"><span class="hs-identifier hs-var">edits</span></a></span><span>
</span><span id="line-257"></span><span>  </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-258"></span><span>    </span><span class="annot"><span class="annottext">FilePath -&gt; LSP ()
forall c (m :: * -&gt; *). MonadLsp c m =&gt; FilePath -&gt; m ()
</span><a href="Language.Rzk.VSCode.Logging.html#logDebug"><span class="hs-identifier hs-var">logDebug</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Formatting is disabled in config&quot;</span></span><span>
</span><span id="line-259"></span><span>    </span><span class="annot"><span class="annottext">Either ResponseError ([TextEdit] |? Null) -&gt; LSP ()
</span><a href="#local-6989586621679735099"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ResponseError ([TextEdit] |? Null) -&gt; LSP ())
-&gt; Either ResponseError ([TextEdit] |? Null) -&gt; LSP ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([TextEdit] |? Null) -&gt; Either ResponseError ([TextEdit] |? Null)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(([TextEdit] |? Null) -&gt; Either ResponseError ([TextEdit] |? Null))
-&gt; ([TextEdit] |? Null)
-&gt; Either ResponseError ([TextEdit] |? Null)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Null -&gt; [TextEdit] |? Null
forall a b. b -&gt; a |? b
</span><span class="hs-identifier hs-var">InR</span></span><span> </span><span class="annot"><span class="annottext">Null
</span><span class="hs-identifier hs-var">Null</span></span><span>
</span><span id="line-260"></span><span>
</span><span id="line-261"></span><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#provideSemanticTokens"><span class="hs-identifier hs-type">provideSemanticTokens</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handler</span></span><span> </span><span class="annot"><a href="Language.Rzk.VSCode.Env.html#LSP"><span class="hs-identifier hs-type">LSP</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">Method_TextDocumentSemanticTokensFull</span></span><span>
</span><span id="line-262"></span><span id="provideSemanticTokens"><span class="annot"><span class="annottext">provideSemanticTokens :: Handler
  (LspT ServerConfig (ReaderT RzkEnv IO))
  'Method_TextDocumentSemanticTokensFull
</span><a href="Language.Rzk.VSCode.Handlers.html#provideSemanticTokens"><span class="hs-identifier hs-var hs-var">provideSemanticTokens</span></a></span></span><span> </span><span id="local-6989586621679735129"><span class="annot"><span class="annottext">TRequestMessage 'Method_TextDocumentSemanticTokensFull
</span><a href="#local-6989586621679735129"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span id="local-6989586621679735130"><span class="annot"><span class="annottext">Either ResponseError (SemanticTokens |? Null) -&gt; LSP ()
</span><a href="#local-6989586621679735130"><span class="hs-identifier hs-var">responder</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-263"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679735142"><span class="annot"><span class="annottext">doc :: NormalizedUri
</span><a href="#local-6989586621679735142"><span class="hs-identifier hs-var hs-var">doc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TRequestMessage 'Method_TextDocumentSemanticTokensFull
</span><a href="#local-6989586621679735129"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">TRequestMessage 'Method_TextDocumentSemanticTokensFull
-&gt; Getting
     NormalizedUri
     (TRequestMessage 'Method_TextDocumentSemanticTokensFull)
     NormalizedUri
-&gt; NormalizedUri
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">(SemanticTokensParams -&gt; Const NormalizedUri SemanticTokensParams)
-&gt; TRequestMessage 'Method_TextDocumentSemanticTokensFull
-&gt; Const
     NormalizedUri
     (TRequestMessage 'Method_TextDocumentSemanticTokensFull)
forall s a. HasParams s a =&gt; Lens' s a
Lens'
  (TRequestMessage 'Method_TextDocumentSemanticTokensFull)
  SemanticTokensParams
</span><span class="hs-identifier hs-var">params</span></span><span> </span><span class="annot"><span class="annottext">((SemanticTokensParams -&gt; Const NormalizedUri SemanticTokensParams)
 -&gt; TRequestMessage 'Method_TextDocumentSemanticTokensFull
 -&gt; Const
      NormalizedUri
      (TRequestMessage 'Method_TextDocumentSemanticTokensFull))
-&gt; ((NormalizedUri -&gt; Const NormalizedUri NormalizedUri)
    -&gt; SemanticTokensParams
    -&gt; Const NormalizedUri SemanticTokensParams)
-&gt; Getting
     NormalizedUri
     (TRequestMessage 'Method_TextDocumentSemanticTokensFull)
     NormalizedUri
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(TextDocumentIdentifier
 -&gt; Const NormalizedUri TextDocumentIdentifier)
-&gt; SemanticTokensParams -&gt; Const NormalizedUri SemanticTokensParams
forall s a. HasTextDocument s a =&gt; Lens' s a
Lens' SemanticTokensParams TextDocumentIdentifier
</span><span class="hs-identifier hs-var">textDocument</span></span><span> </span><span class="annot"><span class="annottext">((TextDocumentIdentifier
  -&gt; Const NormalizedUri TextDocumentIdentifier)
 -&gt; SemanticTokensParams
 -&gt; Const NormalizedUri SemanticTokensParams)
-&gt; ((NormalizedUri -&gt; Const NormalizedUri NormalizedUri)
    -&gt; TextDocumentIdentifier
    -&gt; Const NormalizedUri TextDocumentIdentifier)
-&gt; (NormalizedUri -&gt; Const NormalizedUri NormalizedUri)
-&gt; SemanticTokensParams
-&gt; Const NormalizedUri SemanticTokensParams
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Uri -&gt; Const NormalizedUri Uri)
-&gt; TextDocumentIdentifier
-&gt; Const NormalizedUri TextDocumentIdentifier
forall s a. HasUri s a =&gt; Lens' s a
Lens' TextDocumentIdentifier Uri
</span><span class="hs-identifier hs-var">uri</span></span><span> </span><span class="annot"><span class="annottext">((Uri -&gt; Const NormalizedUri Uri)
 -&gt; TextDocumentIdentifier
 -&gt; Const NormalizedUri TextDocumentIdentifier)
-&gt; ((NormalizedUri -&gt; Const NormalizedUri NormalizedUri)
    -&gt; Uri -&gt; Const NormalizedUri Uri)
-&gt; (NormalizedUri -&gt; Const NormalizedUri NormalizedUri)
-&gt; TextDocumentIdentifier
-&gt; Const NormalizedUri TextDocumentIdentifier
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Uri -&gt; NormalizedUri)
-&gt; (NormalizedUri -&gt; Const NormalizedUri NormalizedUri)
-&gt; Uri
-&gt; Const NormalizedUri Uri
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) s a.
(Profunctor p, Contravariant f) =&gt;
(s -&gt; a) -&gt; Optic' p f s a
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">Uri -&gt; NormalizedUri
</span><span class="hs-identifier hs-var">toNormalizedUri</span></span><span>
</span><span id="line-264"></span><span>  </span><span id="local-6989586621679735143"><span class="annot"><span class="annottext">Maybe VirtualFile
</span><a href="#local-6989586621679735143"><span class="hs-identifier hs-var">mdoc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NormalizedUri
-&gt; LspT ServerConfig (ReaderT RzkEnv IO) (Maybe VirtualFile)
forall config (m :: * -&gt; *).
MonadLsp config m =&gt;
NormalizedUri -&gt; m (Maybe VirtualFile)
</span><span class="hs-identifier hs-var">getVirtualFile</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679735142"><span class="hs-identifier hs-var">doc</span></a></span><span>
</span><span id="line-265"></span><span>  </span><span id="local-6989586621679735144"><span class="annot"><span class="annottext">Either FilePath [SemanticTokenAbsolute]
</span><a href="#local-6989586621679735144"><span class="hs-identifier hs-var">possibleTokens</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VirtualFile -&gt; Text
</span><span class="hs-identifier hs-var">virtualFileText</span></span><span> </span><span class="annot"><span class="annottext">(VirtualFile -&gt; Text) -&gt; Maybe VirtualFile -&gt; Maybe Text
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe VirtualFile
</span><a href="#local-6989586621679735143"><span class="hs-identifier hs-var">mdoc</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-266"></span><span>    </span><span class="annot"><span class="annottext">Maybe Text
</span><span class="hs-identifier hs-var">Nothing</span></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either FilePath [SemanticTokenAbsolute]
-&gt; LspT
     ServerConfig
     (ReaderT RzkEnv IO)
     (Either FilePath [SemanticTokenAbsolute])
forall a. a -&gt; LspT ServerConfig (ReaderT RzkEnv IO) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; Either FilePath [SemanticTokenAbsolute]
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Failed to get file content&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-267"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679735145"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679735145"><span class="hs-identifier hs-var">sourceCode</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Either FilePath Module -&gt; Either FilePath [SemanticTokenAbsolute])
-&gt; LspT ServerConfig (ReaderT RzkEnv IO) (Either FilePath Module)
-&gt; LspT
     ServerConfig
     (ReaderT RzkEnv IO)
     (Either FilePath [SemanticTokenAbsolute])
forall a b.
(a -&gt; b)
-&gt; LspT ServerConfig (ReaderT RzkEnv IO) a
-&gt; LspT ServerConfig (ReaderT RzkEnv IO) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Module -&gt; [SemanticTokenAbsolute])
-&gt; Either FilePath Module
-&gt; Either FilePath [SemanticTokenAbsolute]
forall a b. (a -&gt; b) -&gt; Either FilePath a -&gt; Either FilePath b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Module -&gt; [SemanticTokenAbsolute]
</span><a href="Language.Rzk.VSCode.Tokenize.html#tokenizeModule"><span class="hs-identifier hs-var">tokenizeModule</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(LspT ServerConfig (ReaderT RzkEnv IO) (Either FilePath Module)
 -&gt; LspT
      ServerConfig
      (ReaderT RzkEnv IO)
      (Either FilePath [SemanticTokenAbsolute]))
-&gt; LspT ServerConfig (ReaderT RzkEnv IO) (Either FilePath Module)
-&gt; LspT
     ServerConfig
     (ReaderT RzkEnv IO)
     (Either FilePath [SemanticTokenAbsolute])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either FilePath Module)
-&gt; LspT ServerConfig (ReaderT RzkEnv IO) (Either FilePath Module)
forall a. IO a -&gt; LspT ServerConfig (ReaderT RzkEnv IO) a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either FilePath Module)
 -&gt; LspT ServerConfig (ReaderT RzkEnv IO) (Either FilePath Module))
-&gt; IO (Either FilePath Module)
-&gt; LspT ServerConfig (ReaderT RzkEnv IO) (Either FilePath Module)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-268"></span><span>      </span><span class="annot"><span class="annottext">FilePath -&gt; IO (Either FilePath Module)
</span><a href="Language.Rzk.Syntax.html#parseModuleSafe"><span class="hs-identifier hs-var">parseModuleSafe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; FilePath -&gt; FilePath
forall {a}. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; Char -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'\r'</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; FilePath) -&gt; FilePath -&gt; FilePath
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; FilePath
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679735145"><span class="hs-identifier hs-var">sourceCode</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either FilePath [SemanticTokenAbsolute]
</span><a href="#local-6989586621679735144"><span class="hs-identifier hs-var">possibleTokens</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-270"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679735146"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735146"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-271"></span><span>      </span><span class="hs-comment">-- Exception occurred when parsing the module</span><span>
</span><span id="line-272"></span><span>      </span><span class="annot"><span class="annottext">FilePath -&gt; LSP ()
forall c (m :: * -&gt; *). MonadLsp c m =&gt; FilePath -&gt; m ()
</span><a href="Language.Rzk.VSCode.Logging.html#logWarning"><span class="hs-identifier hs-var">logWarning</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Failed to tokenize file: &quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735146"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679735147"><span class="annot"><span class="annottext">[SemanticTokenAbsolute]
</span><a href="#local-6989586621679735147"><span class="hs-identifier hs-var">tokens</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-274"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679735148"><span class="annot"><span class="annottext">encoded :: Either Text [UInt]
</span><a href="#local-6989586621679735148"><span class="hs-identifier hs-var hs-var">encoded</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SemanticTokensLegend
-&gt; [SemanticTokenRelative] -&gt; Either Text [UInt]
</span><span class="hs-identifier hs-var">encodeTokens</span></span><span> </span><span class="annot"><span class="annottext">SemanticTokensLegend
</span><span class="hs-identifier hs-var">defaultSemanticTokensLegend</span></span><span> </span><span class="annot"><span class="annottext">([SemanticTokenRelative] -&gt; Either Text [UInt])
-&gt; [SemanticTokenRelative] -&gt; Either Text [UInt]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SemanticTokenAbsolute] -&gt; [SemanticTokenRelative]
</span><span class="hs-identifier hs-var">relativizeTokens</span></span><span> </span><span class="annot"><span class="annottext">[SemanticTokenAbsolute]
</span><a href="#local-6989586621679735147"><span class="hs-identifier hs-var">tokens</span></a></span><span>
</span><span id="line-275"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either Text [UInt]
</span><a href="#local-6989586621679735148"><span class="hs-identifier hs-var">encoded</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-276"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679735152"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679735152"><span class="hs-identifier hs-var">_err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-277"></span><span>          </span><span class="hs-comment">-- Failed to encode the tokens</span><span>
</span><span id="line-278"></span><span>          </span><span class="annot"><span class="annottext">() -&gt; LSP ()
forall a. a -&gt; LspT ServerConfig (ReaderT RzkEnv IO) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679735153"><span class="annot"><span class="annottext">[UInt]
</span><a href="#local-6989586621679735153"><span class="hs-identifier hs-var">list</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-280"></span><span>          </span><span class="annot"><span class="annottext">Either ResponseError (SemanticTokens |? Null) -&gt; LSP ()
</span><a href="#local-6989586621679735130"><span class="hs-identifier hs-var">responder</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SemanticTokens |? Null)
-&gt; Either ResponseError (SemanticTokens |? Null)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SemanticTokens -&gt; SemanticTokens |? Null
forall a b. a -&gt; a |? b
</span><span class="hs-identifier hs-var">InL</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Text -&gt; [UInt] -&gt; SemanticTokens
</span><span class="hs-identifier hs-var">SemanticTokens</span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">[UInt]
</span><a href="#local-6989586621679735153"><span class="hs-identifier hs-var">list</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span class="hs-keyword">data</span><span> </span><span id="IsChanged"><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#IsChanged"><span class="hs-identifier hs-var">IsChanged</span></a></span></span><span>
</span><span id="line-284"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="HasChanged"><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#HasChanged"><span class="hs-identifier hs-var">HasChanged</span></a></span></span><span>
</span><span id="line-285"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="NotChanged"><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#NotChanged"><span class="hs-identifier hs-var">NotChanged</span></a></span></span><span>
</span><span id="line-286"></span><span>
</span><span id="line-287"></span><span class="annot"><span class="hs-comment">-- | Detects if the given path has changes in its declaration compared to what's in the cache</span></span><span>
</span><span id="line-288"></span><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#isChanged"><span class="hs-identifier hs-type">isChanged</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Rzk.VSCode.Env.html#RzkTypecheckCache"><span class="hs-identifier hs-type">RzkTypecheckCache</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Rzk.VSCode.Env.html#LSP"><span class="hs-identifier hs-type">LSP</span></a></span><span> </span><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#IsChanged"><span class="hs-identifier hs-type">IsChanged</span></a></span><span>
</span><span id="line-289"></span><span id="isChanged"><span class="annot"><span class="annottext">isChanged :: RzkTypecheckCache -&gt; FilePath -&gt; LSP IsChanged
</span><a href="Language.Rzk.VSCode.Handlers.html#isChanged"><span class="hs-identifier hs-var hs-var">isChanged</span></a></span></span><span> </span><span id="local-6989586621679735158"><span class="annot"><span class="annottext">RzkTypecheckCache
</span><a href="#local-6989586621679735158"><span class="hs-identifier hs-var">cache</span></a></span></span><span> </span><span id="local-6989586621679735159"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735159"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) IsChanged
-&gt; LSP IsChanged
forall {m :: * -&gt; *} {e}.
Monad m =&gt;
ExceptT e m IsChanged -&gt; m IsChanged
</span><a href="#local-6989586621679735160"><span class="hs-identifier hs-var">toIsChanged</span></a></span><span> </span><span class="annot"><span class="annottext">(ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) IsChanged
 -&gt; LSP IsChanged)
-&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) IsChanged
-&gt; LSP IsChanged
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-290"></span><span>  </span><span id="local-6989586621679735161"><span class="annot"><span class="annottext">[Decl']
</span><a href="#local-6989586621679735161"><span class="hs-identifier hs-var">cachedDecls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe [Decl']
-&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) [Decl']
forall {a}.
Maybe a -&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a
</span><a href="#local-6989586621679735162"><span class="hs-identifier hs-var">maybeToEitherLSP</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe [Decl']
 -&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) [Decl'])
-&gt; Maybe [Decl']
-&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) [Decl']
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; RzkTypecheckCache -&gt; Maybe [Decl']
forall a b. Eq a =&gt; a -&gt; [(a, b)] -&gt; Maybe b
</span><span class="hs-identifier hs-var">lookup</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735159"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">RzkTypecheckCache
</span><a href="#local-6989586621679735158"><span class="hs-identifier hs-var">cache</span></a></span><span>
</span><span id="line-291"></span><span>  </span><span id="local-6989586621679735164"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621679735164"><span class="hs-identifier hs-var">module'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Either FilePath Module)
-&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) Module
forall {e} {a}.
IO (Either e a)
-&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a
</span><a href="#local-6989586621679735165"><span class="hs-identifier hs-var">toExceptTLifted</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (Either FilePath Module)
 -&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) Module)
-&gt; IO (Either FilePath Module)
-&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) Module
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO (Either FilePath Module)
</span><a href="Language.Rzk.Syntax.html#parseModuleFile"><span class="hs-identifier hs-var">parseModuleFile</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735159"><span class="hs-identifier hs-var">path</span></a></span><span>
</span><span id="line-292"></span><span>  </span><span id="local-6989586621679735166"><span class="annot"><span class="annottext">Either
  (TypeErrorInScopedContext VarIdent)
  (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])
</span><a href="#local-6989586621679735166"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO
  (Either
     SomeException
     (Either
        (TypeErrorInScopedContext VarIdent)
        (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])))
-&gt; ExceptT
     ()
     (LspT ServerConfig (ReaderT RzkEnv IO))
     (Either
        (TypeErrorInScopedContext VarIdent)
        (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent]))
forall {e} {a}.
IO (Either e a)
-&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a
</span><a href="#local-6989586621679735165"><span class="hs-identifier hs-var">toExceptTLifted</span></a></span><span> </span><span class="annot"><span class="annottext">(IO
   (Either
      SomeException
      (Either
         (TypeErrorInScopedContext VarIdent)
         (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])))
 -&gt; ExceptT
      ()
      (LspT ServerConfig (ReaderT RzkEnv IO))
      (Either
         (TypeErrorInScopedContext VarIdent)
         (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])))
-&gt; IO
     (Either
        SomeException
        (Either
           (TypeErrorInScopedContext VarIdent)
           (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])))
-&gt; ExceptT
     ()
     (LspT ServerConfig (ReaderT RzkEnv IO))
     (Either
        (TypeErrorInScopedContext VarIdent)
        (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall e a. Exception e =&gt; IO a -&gt; IO (Either e a)
</span><span class="hs-identifier hs-var">try</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span> </span><span class="annot"><span class="annottext">(IO
   (Either
      (TypeErrorInScopedContext VarIdent)
      (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent]))
 -&gt; IO
      (Either
         SomeException
         (Either
            (TypeErrorInScopedContext VarIdent)
            (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent]))))
-&gt; IO
     (Either
        (TypeErrorInScopedContext VarIdent)
        (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent]))
-&gt; IO
     (Either
        SomeException
        (Either
           (TypeErrorInScopedContext VarIdent)
           (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Either
  (TypeErrorInScopedContext VarIdent)
  (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])
-&gt; IO
     (Either
        (TypeErrorInScopedContext VarIdent)
        (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent]))
forall a. a -&gt; IO a
</span><span class="hs-identifier hs-var">evaluate</span></span><span> </span><span class="annot"><span class="annottext">(Either
   (TypeErrorInScopedContext VarIdent)
   (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])
 -&gt; IO
      (Either
         (TypeErrorInScopedContext VarIdent)
         (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])))
-&gt; Either
     (TypeErrorInScopedContext VarIdent)
     (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])
-&gt; IO
     (Either
        (TypeErrorInScopedContext VarIdent)
        (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-293"></span><span>    </span><span class="annot"><span class="annottext">TypeCheck
  VarIdent (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])
-&gt; Either
     (TypeErrorInScopedContext VarIdent)
     (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])
forall var a.
TypeCheck var a -&gt; Either (TypeErrorInScopedContext var) a
</span><a href="Rzk.TypeCheck.html#defaultTypeCheck"><span class="hs-identifier hs-var">defaultTypeCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RzkTypecheckCache
-&gt; [(FilePath, Module)]
-&gt; TypeCheck
     VarIdent (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])
</span><a href="Rzk.TypeCheck.html#typecheckModulesWithLocationIncremental"><span class="hs-identifier hs-var">typecheckModulesWithLocationIncremental</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((FilePath, [Decl']) -&gt; Bool)
-&gt; RzkTypecheckCache -&gt; RzkTypecheckCache
forall {a}. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">takeWhile</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735159"><span class="hs-identifier hs-var">path</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; Bool)
-&gt; ((FilePath, [Decl']) -&gt; FilePath) -&gt; (FilePath, [Decl']) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(FilePath, [Decl']) -&gt; FilePath
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RzkTypecheckCache
</span><a href="#local-6989586621679735158"><span class="hs-identifier hs-var">cache</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735159"><span class="hs-identifier hs-var">path</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621679735164"><span class="hs-identifier hs-var">module'</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-294"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679735168"><span class="annot"><span class="annottext">RzkTypecheckCache
</span><a href="#local-6989586621679735168"><span class="hs-identifier hs-var">checkedModules</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679735169"><span class="annot"><span class="annottext">[TypeErrorInScopedContext VarIdent]
</span><a href="#local-6989586621679735169"><span class="hs-identifier hs-var">_errors</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExceptT
  ()
  (LspT ServerConfig (ReaderT RzkEnv IO))
  (Either
     (TypeErrorInScopedContext VarIdent)
     (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent]))
-&gt; ExceptT
     ()
     (LspT ServerConfig (ReaderT RzkEnv IO))
     (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])
forall {e} {a}.
ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) (Either e a)
-&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a
</span><a href="#local-6989586621679735170"><span class="hs-identifier hs-var">toExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ExceptT
   ()
   (LspT ServerConfig (ReaderT RzkEnv IO))
   (Either
      (TypeErrorInScopedContext VarIdent)
      (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent]))
 -&gt; ExceptT
      ()
      (LspT ServerConfig (ReaderT RzkEnv IO))
      (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent]))
-&gt; ExceptT
     ()
     (LspT ServerConfig (ReaderT RzkEnv IO))
     (Either
        (TypeErrorInScopedContext VarIdent)
        (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent]))
-&gt; ExceptT
     ()
     (LspT ServerConfig (ReaderT RzkEnv IO))
     (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Either
  (TypeErrorInScopedContext VarIdent)
  (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])
-&gt; ExceptT
     ()
     (LspT ServerConfig (ReaderT RzkEnv IO))
     (Either
        (TypeErrorInScopedContext VarIdent)
        (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent]))
forall a. a -&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Either
  (TypeErrorInScopedContext VarIdent)
  (RzkTypecheckCache, [TypeErrorInScopedContext VarIdent])
</span><a href="#local-6989586621679735166"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-295"></span><span>  </span><span id="local-6989586621679735171"><span class="annot"><span class="annottext">[Decl']
</span><a href="#local-6989586621679735171"><span class="hs-identifier hs-var">decls'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe [Decl']
-&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) [Decl']
forall {a}.
Maybe a -&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a
</span><a href="#local-6989586621679735162"><span class="hs-identifier hs-var">maybeToEitherLSP</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe [Decl']
 -&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) [Decl'])
-&gt; Maybe [Decl']
-&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) [Decl']
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; RzkTypecheckCache -&gt; Maybe [Decl']
forall a b. Eq a =&gt; a -&gt; [(a, b)] -&gt; Maybe b
</span><span class="hs-identifier hs-var">lookup</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735159"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">RzkTypecheckCache
</span><a href="#local-6989586621679735168"><span class="hs-identifier hs-var">checkedModules</span></a></span><span>
</span><span id="line-296"></span><span>  </span><span class="annot"><span class="annottext">IsChanged
-&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) IsChanged
forall a. a -&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(IsChanged
 -&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) IsChanged)
-&gt; IsChanged
-&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) IsChanged
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[Decl']
</span><a href="#local-6989586621679735171"><span class="hs-identifier hs-var">decls'</span></a></span><span> </span><span class="annot"><span class="annottext">[Decl'] -&gt; [Decl'] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[Decl']
</span><a href="#local-6989586621679735161"><span class="hs-identifier hs-var">cachedDecls</span></a></span><span>
</span><span id="line-297"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">IsChanged
</span><a href="Language.Rzk.VSCode.Handlers.html#NotChanged"><span class="hs-identifier hs-var">NotChanged</span></a></span><span>
</span><span id="line-298"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">IsChanged
</span><a href="Language.Rzk.VSCode.Handlers.html#HasChanged"><span class="hs-identifier hs-var">HasChanged</span></a></span><span>
</span><span id="line-299"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-300"></span><span>    </span><span id="local-6989586621679735170"><span class="annot"><span class="annottext">toExceptT :: ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) (Either e a)
-&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a
</span><a href="#local-6989586621679735170"><span class="hs-identifier hs-var hs-var">toExceptT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(e -&gt; ())
-&gt; ExceptT e (ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO))) a
-&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a
forall e' (m :: * -&gt; *) e a.
MonadError e' m =&gt;
(e -&gt; e') -&gt; ExceptT e m a -&gt; m a
</span><span class="hs-identifier hs-var">modifyError</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; e -&gt; ()
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExceptT e (ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO))) a
 -&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a)
-&gt; (ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) (Either e a)
    -&gt; ExceptT
         e (ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO))) a)
-&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) (Either e a)
-&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) (Either e a)
-&gt; ExceptT e (ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO))) a
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">ExceptT</span></span><span>
</span><span id="line-301"></span><span>    </span><span id="local-6989586621679735165"><span class="annot"><span class="annottext">toExceptTLifted :: IO (Either e a)
-&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a
</span><a href="#local-6989586621679735165"><span class="hs-identifier hs-var hs-var">toExceptTLifted</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) (Either e a)
-&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a
forall {e} {a}.
ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) (Either e a)
-&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a
</span><a href="#local-6989586621679735170"><span class="hs-identifier hs-var">toExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) (Either e a)
 -&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a)
-&gt; (IO (Either e a)
    -&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) (Either e a))
-&gt; IO (Either e a)
-&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IO (Either e a)
-&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) (Either e a)
forall a.
IO a -&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-302"></span><span>    </span><span id="local-6989586621679735162"><span class="annot"><span class="annottext">maybeToEitherLSP :: Maybe a -&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a
</span><a href="#local-6989586621679735162"><span class="hs-identifier hs-var hs-var">maybeToEitherLSP</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-303"></span><span>      </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a
forall a.
() -&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679735192"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679735192"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a
forall a. a -&gt; ExceptT () (LspT ServerConfig (ReaderT RzkEnv IO)) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679735192"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-305"></span><span>    </span><span id="local-6989586621679735160"><span class="annot"><span class="annottext">toIsChanged :: ExceptT e m IsChanged -&gt; m IsChanged
</span><a href="#local-6989586621679735160"><span class="hs-identifier hs-var hs-var">toIsChanged</span></a></span></span><span> </span><span id="local-6989586621679735203"><span class="annot"><span class="annottext">ExceptT e m IsChanged
</span><a href="#local-6989586621679735203"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT e m IsChanged -&gt; m (Either e IsChanged)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">ExceptT e m IsChanged
</span><a href="#local-6989586621679735203"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">m (Either e IsChanged)
-&gt; (Either e IsChanged -&gt; m IsChanged) -&gt; m IsChanged
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-306"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">e
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IsChanged -&gt; m IsChanged
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">IsChanged
</span><a href="Language.Rzk.VSCode.Handlers.html#HasChanged"><span class="hs-identifier hs-var">HasChanged</span></a></span><span> </span><span class="hs-comment">-- in case of error consider the file has changed</span><span>
</span><span id="line-307"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679735204"><span class="annot"><span class="annottext">IsChanged
</span><a href="#local-6989586621679735204"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IsChanged -&gt; m IsChanged
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">IsChanged
</span><a href="#local-6989586621679735204"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-308"></span><span>
</span><span id="line-309"></span><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#hasNotChanged"><span class="hs-identifier hs-type">hasNotChanged</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Rzk.VSCode.Env.html#RzkTypecheckCache"><span class="hs-identifier hs-type">RzkTypecheckCache</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Rzk.VSCode.Env.html#LSP"><span class="hs-identifier hs-type">LSP</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-310"></span><span id="hasNotChanged"><span class="annot"><span class="annottext">hasNotChanged :: RzkTypecheckCache -&gt; FilePath -&gt; LSP Bool
</span><a href="Language.Rzk.VSCode.Handlers.html#hasNotChanged"><span class="hs-identifier hs-var hs-var">hasNotChanged</span></a></span></span><span> </span><span id="local-6989586621679735206"><span class="annot"><span class="annottext">RzkTypecheckCache
</span><a href="#local-6989586621679735206"><span class="hs-identifier hs-var">cache</span></a></span></span><span> </span><span id="local-6989586621679735207"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735207"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RzkTypecheckCache -&gt; FilePath -&gt; LSP IsChanged
</span><a href="Language.Rzk.VSCode.Handlers.html#isChanged"><span class="hs-identifier hs-var">isChanged</span></a></span><span> </span><span class="annot"><span class="annottext">RzkTypecheckCache
</span><a href="#local-6989586621679735206"><span class="hs-identifier hs-var">cache</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679735207"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">LSP IsChanged -&gt; (IsChanged -&gt; LSP Bool) -&gt; LSP Bool
forall a b.
LspT ServerConfig (ReaderT RzkEnv IO) a
-&gt; (a -&gt; LspT ServerConfig (ReaderT RzkEnv IO) b)
-&gt; LspT ServerConfig (ReaderT RzkEnv IO) b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-311"></span><span>  </span><span class="annot"><span class="annottext">IsChanged
</span><a href="Language.Rzk.VSCode.Handlers.html#HasChanged"><span class="hs-identifier hs-var">HasChanged</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; LSP Bool
forall a. a -&gt; LspT ServerConfig (ReaderT RzkEnv IO) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-312"></span><span>  </span><span class="annot"><span class="annottext">IsChanged
</span><a href="Language.Rzk.VSCode.Handlers.html#NotChanged"><span class="hs-identifier hs-var">NotChanged</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; LSP Bool
forall a. a -&gt; LspT ServerConfig (ReaderT RzkEnv IO) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span class="annot"><span class="hs-comment">-- | Monadic 'dropWhile'</span></span><span>
</span><span id="line-315"></span><span id="local-6989586621679734499"><span id="local-6989586621679734500"><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#dropWhileM"><span class="hs-identifier hs-type">dropWhileM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679734499"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679734500"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679734499"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679734500"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679734499"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679734500"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-316"></span><span id="dropWhileM"><span class="annot"><span class="annottext">dropWhileM :: forall (m :: * -&gt; *) a. Monad m =&gt; (a -&gt; m Bool) -&gt; [a] -&gt; m [a]
</span><a href="Language.Rzk.VSCode.Handlers.html#dropWhileM"><span class="hs-identifier hs-var hs-var">dropWhileM</span></a></span></span><span> </span><span class="annot"><span class="annottext">a -&gt; m Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; m [a]
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-317"></span><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#dropWhileM"><span class="hs-identifier hs-var">dropWhileM</span></a></span><span> </span><span id="local-6989586621679735215"><span class="annot"><span class="annottext">a -&gt; m Bool
</span><a href="#local-6989586621679735215"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679735216"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679735216"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679735217"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679735217"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-318"></span><span>  </span><span id="local-6989586621679735218"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679735218"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; m Bool
</span><a href="#local-6989586621679735215"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679735216"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-319"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679735218"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(a -&gt; m Bool) -&gt; [a] -&gt; m [a]
forall (m :: * -&gt; *) a. Monad m =&gt; (a -&gt; m Bool) -&gt; [a] -&gt; m [a]
</span><a href="Language.Rzk.VSCode.Handlers.html#dropWhileM"><span class="hs-identifier hs-var">dropWhileM</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m Bool
</span><a href="#local-6989586621679735215"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679735217"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-321"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; m [a]
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679735216"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679735217"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span class="annot"><a href="Language.Rzk.VSCode.Handlers.html#handleFilesChanged"><span class="hs-identifier hs-type">handleFilesChanged</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handler</span></span><span> </span><span class="annot"><a href="Language.Rzk.VSCode.Env.html#LSP"><span class="hs-identifier hs-type">LSP</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">Method_WorkspaceDidChangeWatchedFiles</span></span><span>
</span><span id="line-324"></span><span id="handleFilesChanged"><span class="annot"><span class="annottext">handleFilesChanged :: Handler
  (LspT ServerConfig (ReaderT RzkEnv IO))
  'Method_WorkspaceDidChangeWatchedFiles
</span><a href="Language.Rzk.VSCode.Handlers.html#handleFilesChanged"><span class="hs-identifier hs-var hs-var">handleFilesChanged</span></a></span></span><span> </span><span id="local-6989586621679735219"><span class="annot"><span class="annottext">TNotificationMessage 'Method_WorkspaceDidChangeWatchedFiles
</span><a href="#local-6989586621679735219"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-325"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679735245"><span class="annot"><span class="annottext">modifiedPaths :: [FilePath]
</span><a href="#local-6989586621679735245"><span class="hs-identifier hs-var hs-var">modifiedPaths</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TNotificationMessage 'Method_WorkspaceDidChangeWatchedFiles
</span><a href="#local-6989586621679735219"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">TNotificationMessage 'Method_WorkspaceDidChangeWatchedFiles
-&gt; Getting
     (Endo [FilePath])
     (TNotificationMessage 'Method_WorkspaceDidChangeWatchedFiles)
     FilePath
-&gt; [FilePath]
forall s a. s -&gt; Getting (Endo [a]) s a -&gt; [a]
</span><span class="hs-operator hs-var">^..</span></span><span> </span><span class="annot"><span class="annottext">(DidChangeWatchedFilesParams
 -&gt; Const (Endo [FilePath]) DidChangeWatchedFilesParams)
-&gt; TNotificationMessage 'Method_WorkspaceDidChangeWatchedFiles
-&gt; Const
     (Endo [FilePath])
     (TNotificationMessage 'Method_WorkspaceDidChangeWatchedFiles)
forall s a. HasParams s a =&gt; Lens' s a
Lens'
  (TNotificationMessage 'Method_WorkspaceDidChangeWatchedFiles)
  DidChangeWatchedFilesParams
</span><span class="hs-identifier hs-var">params</span></span><span> </span><span class="annot"><span class="annottext">((DidChangeWatchedFilesParams
  -&gt; Const (Endo [FilePath]) DidChangeWatchedFilesParams)
 -&gt; TNotificationMessage 'Method_WorkspaceDidChangeWatchedFiles
 -&gt; Const
      (Endo [FilePath])
      (TNotificationMessage 'Method_WorkspaceDidChangeWatchedFiles))
-&gt; ((FilePath -&gt; Const (Endo [FilePath]) FilePath)
    -&gt; DidChangeWatchedFilesParams
    -&gt; Const (Endo [FilePath]) DidChangeWatchedFilesParams)
-&gt; Getting
     (Endo [FilePath])
     (TNotificationMessage 'Method_WorkspaceDidChangeWatchedFiles)
     FilePath
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">([FileEvent] -&gt; Const (Endo [FilePath]) [FileEvent])
-&gt; DidChangeWatchedFilesParams
-&gt; Const (Endo [FilePath]) DidChangeWatchedFilesParams
forall s a. HasChanges s a =&gt; Lens' s a
Lens' DidChangeWatchedFilesParams [FileEvent]
</span><span class="hs-identifier hs-var">changes</span></span><span> </span><span class="annot"><span class="annottext">(([FileEvent] -&gt; Const (Endo [FilePath]) [FileEvent])
 -&gt; DidChangeWatchedFilesParams
 -&gt; Const (Endo [FilePath]) DidChangeWatchedFilesParams)
-&gt; ((FilePath -&gt; Const (Endo [FilePath]) FilePath)
    -&gt; [FileEvent] -&gt; Const (Endo [FilePath]) [FileEvent])
-&gt; (FilePath -&gt; Const (Endo [FilePath]) FilePath)
-&gt; DidChangeWatchedFilesParams
-&gt; Const (Endo [FilePath]) DidChangeWatchedFilesParams
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(FileEvent -&gt; Const (Endo [FilePath]) FileEvent)
-&gt; [FileEvent] -&gt; Const (Endo [FilePath]) [FileEvent]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; [a] -&gt; f [b]
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">((FileEvent -&gt; Const (Endo [FilePath]) FileEvent)
 -&gt; [FileEvent] -&gt; Const (Endo [FilePath]) [FileEvent])
-&gt; ((FilePath -&gt; Const (Endo [FilePath]) FilePath)
    -&gt; FileEvent -&gt; Const (Endo [FilePath]) FileEvent)
-&gt; (FilePath -&gt; Const (Endo [FilePath]) FilePath)
-&gt; [FileEvent]
-&gt; Const (Endo [FilePath]) [FileEvent]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Uri -&gt; Const (Endo [FilePath]) Uri)
-&gt; FileEvent -&gt; Const (Endo [FilePath]) FileEvent
forall s a. HasUri s a =&gt; Lens' s a
Lens' FileEvent Uri
</span><span class="hs-identifier hs-var">uri</span></span><span> </span><span class="annot"><span class="annottext">((Uri -&gt; Const (Endo [FilePath]) Uri)
 -&gt; FileEvent -&gt; Const (Endo [FilePath]) FileEvent)
-&gt; ((FilePath -&gt; Const (Endo [FilePath]) FilePath)
    -&gt; Uri -&gt; Const (Endo [FilePath]) Uri)
-&gt; (FilePath -&gt; Const (Endo [FilePath]) FilePath)
-&gt; FileEvent
-&gt; Const (Endo [FilePath]) FileEvent
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Uri -&gt; Maybe FilePath)
-&gt; (Maybe FilePath -&gt; Const (Endo [FilePath]) (Maybe FilePath))
-&gt; Uri
-&gt; Const (Endo [FilePath]) Uri
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) s a.
(Profunctor p, Contravariant f) =&gt;
(s -&gt; a) -&gt; Optic' p f s a
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">Uri -&gt; Maybe FilePath
</span><span class="hs-identifier hs-var">uriToFilePath</span></span><span> </span><span class="annot"><span class="annottext">((Maybe FilePath -&gt; Const (Endo [FilePath]) (Maybe FilePath))
 -&gt; Uri -&gt; Const (Endo [FilePath]) Uri)
-&gt; ((FilePath -&gt; Const (Endo [FilePath]) FilePath)
    -&gt; Maybe FilePath -&gt; Const (Endo [FilePath]) (Maybe FilePath))
-&gt; (FilePath -&gt; Const (Endo [FilePath]) FilePath)
-&gt; Uri
-&gt; Const (Endo [FilePath]) Uri
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; Const (Endo [FilePath]) FilePath)
-&gt; Maybe FilePath -&gt; Const (Endo [FilePath]) (Maybe FilePath)
forall a b (p :: * -&gt; * -&gt; *) (f :: * -&gt; *).
(Choice p, Applicative f) =&gt;
p a (f b) -&gt; p (Maybe a) (f (Maybe b))
</span><span class="hs-identifier hs-var">_Just</span></span><span>
</span><span id="line-326"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; Bool) -&gt; [FilePath] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;rzk.yaml&quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; Bool
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; Bool
</span><span class="hs-operator hs-var">`isSuffixOf`</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679735245"><span class="hs-identifier hs-var">modifiedPaths</span></a></span><span>
</span><span id="line-327"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-328"></span><span>      </span><span class="annot"><span class="annottext">FilePath -&gt; LSP ()
forall c (m :: * -&gt; *). MonadLsp c m =&gt; FilePath -&gt; m ()
</span><a href="Language.Rzk.VSCode.Logging.html#logDebug"><span class="hs-identifier hs-var">logDebug</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;rzk.yaml modified. Clearing module cache&quot;</span></span><span>
</span><span id="line-329"></span><span>      </span><span class="annot"><span class="annottext">LSP ()
</span><a href="Language.Rzk.VSCode.Env.html#resetCacheForAllFiles"><span class="hs-identifier hs-var">resetCacheForAllFiles</span></a></span><span>
</span><span id="line-330"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-331"></span><span>      </span><span id="local-6989586621679735251"><span class="annot"><span class="annottext">RzkTypecheckCache
</span><a href="#local-6989586621679735251"><span class="hs-identifier hs-var">cache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LSP RzkTypecheckCache
</span><a href="Language.Rzk.VSCode.Env.html#getCachedTypecheckedModules"><span class="hs-identifier hs-var">getCachedTypecheckedModules</span></a></span><span>
</span><span id="line-332"></span><span>      </span><span id="local-6989586621679735252"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679735252"><span class="hs-identifier hs-var">actualModified</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; LSP Bool)
-&gt; [FilePath] -&gt; LspT ServerConfig (ReaderT RzkEnv IO) [FilePath]
forall (m :: * -&gt; *) a. Monad m =&gt; (a -&gt; m Bool) -&gt; [a] -&gt; m [a]
</span><a href="Language.Rzk.VSCode.Handlers.html#dropWhileM"><span class="hs-identifier hs-var">dropWhileM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RzkTypecheckCache -&gt; FilePath -&gt; LSP Bool
</span><a href="Language.Rzk.VSCode.Handlers.html#hasNotChanged"><span class="hs-identifier hs-var">hasNotChanged</span></a></span><span> </span><span class="annot"><span class="annottext">RzkTypecheckCache
</span><a href="#local-6989586621679735251"><span class="hs-identifier hs-var">cache</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679735245"><span class="hs-identifier hs-var">modifiedPaths</span></a></span><span>
</span><span id="line-333"></span><span>      </span><span class="annot"><span class="annottext">[FilePath] -&gt; LSP ()
</span><a href="Language.Rzk.VSCode.Env.html#resetCacheForFiles"><span class="hs-identifier hs-var">resetCacheForFiles</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679735252"><span class="hs-identifier hs-var">actualModified</span></a></span><span>
</span><span id="line-334"></span><span>  </span><span class="annot"><span class="annottext">LSP ()
</span><a href="Language.Rzk.VSCode.Handlers.html#typecheckFromConfigFile"><span class="hs-identifier hs-var">typecheckFromConfigFile</span></a></span><span>
</span><span id="line-335"></span></pre></body></html>